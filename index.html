html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wano App</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Optional: Use a font closer to Android's default -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Global Reset & App Structure --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif; /* Android-like font */
            background-color: #f0f0f0; /* Slightly off-white background */
            overflow: hidden; /* Prevent scrolling on body */
            color: #333;
            font-size: 16px;
        }

        #app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for fixed alert button positioning context */
        }

        /* --- App Header (AppBar Simulation) --- */
        .app-header {
            background-color: #4CAF50; /* Primary color */
            color: white;
            padding: 0 16px;
            height: 56px; /* Standard AppBar height */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            position: sticky; /* Or fixed if needed, but sticky is often better */
            top: 0;
            z-index: 1000;
        }
        .app-header .logo-title {
            display: flex;
            align-items: center;
            gap: 8px; /* Space between logo and title */
            text-decoration: none; /* Remove underline if it's a link */
            color: white; /* Inherit color */
        }
        .app-header .logo-title img {
             height: 30px; /* Adjust height as needed */
             width: auto; /* Maintain aspect ratio */
             vertical-align: middle; /* Align logo vertically */
         }
        .app-header .logo-title h1 {
            margin: 0;
            font-size: 1.25em; /* 20px */
            font-weight: 500;
            line-height: 1; /* Ensure text aligns well */
        }
        .app-header #user-status {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between status items */
        }
        .app-header #user-status span {
            font-size: 0.8em; /* 12.8px */
            /* margin-right: 8px; */ /* Replaced by gap */
            max-width: 150px; /* Limit width */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .app-header #user-status button,
        .app-header #user-status .header-button { /* Target specific header buttons */
             /* margin-left: 5px; */ /* Replaced by gap */
             padding: 6px 10px;
             font-size: 0.8em; /* 12.8px */
             background-color: rgba(255, 255, 255, 0.2);
             border: 1px solid rgba(255, 255, 255, 0.5);
             color: white;
             border-radius: 4px;
             cursor: pointer;
             font-weight: 500;
        }
        .app-header #user-status button.danger {
             background-color: #f44336; border: none;
        }
         .app-header #user-status button.info {
             background-color: #2196F3; border: none;
         }
         .app-header #user-status button.warning { /* For Police */
             background-color: #ff9800; border: none;
         }
        .app-header #user-status button:hover,
        .app-header #user-status .header-button:hover {
             background-color: rgba(255, 255, 255, 0.3);
        }
        .app-header #user-status button.danger:hover { background-color: #e53935; }
        .app-header #user-status button.info:hover { background-color: #1E88E5; }
         .app-header #user-status button.warning:hover { background-color: #fb8c00; }


        /* --- App Content Area --- */
        .app-content {
            flex-grow: 1;
            overflow-y: auto; /* Enable vertical scrolling */
            overflow-x: hidden; /* Disable horizontal scrolling */
            padding: 16px;
            background-color: #f4f4f4; /* Content background */
             -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* --- App Footer (Bottom Navigation Simulation) --- */
        .app-footer {
            height: 60px; /* Bottom nav height */
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around; /* Adjust if needed */
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
            position: sticky; /* Or fixed */
            bottom: 0;
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #757575; /* Grey */
            background: none;
            border: none;
            padding: 4px 0;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            height: 100%;
            max-width: 20%; /* Prevent items getting too wide with more buttons */
        }
        .nav-item .material-icons {
            font-size: 24px; /* Icon size */
            margin-bottom: 2px;
        }
        .nav-item.active {
            color: #4CAF50; /* Primary color for active item */
        }
        .nav-item:disabled {
             color: #bdbdbd; /* Disabled color */
             cursor: not-allowed;
             opacity: 0.6;
        }


        /* --- Screen/View Management --- */
        .app-screen {
            display: none; /* Hide all screens initially */
            animation: fadeIn 0.3s ease-in-out;
        }
        .app-screen.active {
            display: block; /* Show the active screen */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Content Styling Adjustments --- */
        /* Remove container max-width and padding for mobile */
        .container {
            max-width: 100%;
            margin: 0 auto; /* Still center if screen is wider */
            background-color: transparent; /* Use app-content background */
            padding: 0; /* Remove padding, handled by app-content */
            border-radius: 0;
            box-shadow: none;
        }

        /* Style section headers to look more like mobile titles */
        h2, h3.section-header {
            background-color: transparent;
            color: #4CAF50; /* Theme color */
            padding: 10px 0px; /* Reduced padding */
            border-radius: 0;
            margin-bottom: 16px;
            margin-top: 16px; /* Add top margin */
            font-size: 1.15em; /* 18.4px */
            font-weight: 500;
            text-align: left; /* Align left */
            border-bottom: 1px solid #e0e0e0;
        }
        h2:first-child, h3.section-header:first-child {
            margin-top: 0; /* No top margin for the very first header */
        }
         h3 { /* Other h3s */
            text-align: left;
             margin-bottom: 16px;
             margin-top: 16px;
             color: #555;
             font-size: 1.05em; /* 16.8px */
             font-weight: 500;
         }

        /* Form Styling */
        form {
            background-color: #ffffff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
         /* Exception for auth forms which are the primary content on their screen */
         #auth-screen form { margin-bottom: 0; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em; /* 14.4px */
            color: #666;
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="file"], input[type="date"], input[type="search"], select, textarea {
            width: 100%;
            padding: 12px 10px;
            margin-bottom: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em; /* 16px */
            background-color: #f9f9f9;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="file"]:focus, input[type="date"]:focus, input[type="search"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50; /* Highlight focus */
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
            background-color: #fff;
        }
        textarea { min-height: 80px; }
        input[type="file"] { background-color: #fff; padding: 8px 10px;}

         .password-wrapper { position: relative; margin-bottom: 16px; }
         .password-wrapper input[type="password"], .password-wrapper input[type="text"] {
             padding-right: 45px; /* Space for icon */
             margin-bottom: 0; /* Remove margin from input itself */
         }
         .password-toggle { /* Style as icon */
             position: absolute;
             right: 0px;
             top: 0px;
             width: 45px; /* Width of the touch area */
             height: 45px; /* Match input height approx */
             cursor: pointer;
             display: flex;
             align-items: center;
             justify-content: center;
             color: #757575;
             -webkit-appearance: none; /* Override default checkbox */
             appearance: none;
             background: transparent;
             border: none;
             outline: none;
         }
         .password-toggle::after { /* Use Material Icons */
             font-family: 'Material Icons';
             content: 'visibility_off'; /* Icon name */
             font-size: 22px;
         }
         .password-toggle:checked::after {
             content: 'visibility'; /* Icon name */
         }

        select {
             appearance: none; /* Remove default arrow */
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23757575%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
             background-repeat: no-repeat;
             background-position: right 10px top 50%;
             background-size: 12px auto;
             padding-right: 35px; /* Space for custom arrow */
             height: 46px; /* Consistent height */
        }

        /* Button Styling */
        button, .button-like { /* Add class for elements acting like buttons */
            display: inline-block; /* Or block if full width */
            padding: 10px 20px;
            background-color: #4CAF50; /* Primary */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em; /* 15.2px */
            font-weight: 500;
            text-align: center;
            text-transform: uppercase; /* Material button style */
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-top: 10px; /* Add top margin */
            margin-bottom: 5px; /* Consistent bottom margin */
            vertical-align: middle; /* Align buttons nicely */
        }
        button:hover, .button-like:hover {
            background-color: #45a049;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        button:active, .button-like:active {
            background-color: #3e8e41;
             box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        button:disabled, .button-like:disabled {
            background-color: #bdbdbd;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
        button.secondary { background-color: #2196F3; /* Blue */ }
        button.secondary:hover { background-color: #1E88E5; }
        button.secondary:active { background-color: #1976D2; }
        button.danger { background-color: #f44336; /* Red */ }
        button.danger:hover { background-color: #e53935; }
        button.danger:active { background-color: #d32f2f; }
        button.info { background-color: #03A9F4; /* Light Blue */ }
        button.info:hover { background-color: #039BE5; }
        button.info:active { background-color: #0288D1; }
        button.warning { background-color: #ff9800; /* Orange */ color: white; }
        button.warning:hover { background-color: #fb8c00; }
        button.warning:active { background-color: #f57c00; }

        button.small { padding: 6px 12px; font-size: 0.8em; margin-top: 5px; margin-bottom: 5px; text-transform: none; /* Don't uppercase small buttons */ box-shadow: none;}
        button.full-width { display: block; width: 100%; margin-right: 0; margin-left: 0; }


        /* --- Tables --- */
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background-color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        /* For smaller screens, allow horizontal scrolling */
        .table-responsive-wrapper {
            overflow-x: auto;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        th, td { padding: 10px 12px; text-align: left; vertical-align: middle; border-bottom: 1px solid #e0e0e0; }
        th { background-color: #f5f5f5; color: #555; font-weight: 500; font-size: 0.9em; border-bottom-width: 2px; white-space: nowrap;}
        tbody tr:last-child td { border-bottom: none; }
        td img.product-image { max-width: 60px; max-height: 60px; border-radius: 4px; object-fit: cover; display: block; }
        .price { font-weight: bold; color: #4CAF50; }
        .total-cost { font-size: 1.1em; font-weight: 500; text-align: right; margin: 16px 0; color: #28a745; padding: 10px; background-color: #e8f5e9; border-radius: 4px;}
        td ul { margin: 0; padding-left: 18px; font-size: 0.9em; } /* Style for item lists in tables */
        td small { color: #777; font-size: 0.85em; } /* Small text in table cells */


        /* --- Product Cards --- */
        #customer-product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .product-card { border: none; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .product-card img.product-image { width: 100%; height: 150px; object-fit: cover; margin-bottom: 0; border-radius: 0; }
        .product-card-content { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-card h4 { margin: 0 0 4px 0; color: #333; font-size: 1em; font-weight: 500; min-height: 2.4em; /* Allow for 2 lines */ line-height: 1.2em; }
        .product-card p { margin-bottom: 8px; font-size: 0.85em; /* 13.6px */ color: #666; flex-grow: 1; line-height: 1.3; }
        .product-card .price { margin-bottom: 10px; font-size: 1.05em; }
        .product-card .business-info { font-size: 0.8em; /* 12.8px */ color: #777; margin-top: auto; border-top: 1px dashed #eee; padding-top: 8px; display: flex; align-items: center; }
        .product-card .business-info strong { color: #555; font-weight: 500; }
        .owner-photo { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid #ddd; flex-shrink: 0; }
        .product-card .order-controls { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-top: 10px; border-top: 1px solid #eee; flex-wrap: wrap; }
        .product-card .order-controls label { font-size: 0.85em; margin-bottom: 0; font-weight: normal; margin-right: 2px; }
        .product-card .order-controls input[type="number"] { width: 55px; padding: 6px; font-size: 0.9em; margin-bottom: 0; text-align: center; height: 32px; }
        .product-card .order-controls button { padding: 6px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; height: 32px; box-shadow: none; }

        /* --- Product Rating Styles --- */
        .product-rating { margin-top: 8px; font-size: 0.9em; color: #666; display: flex; align-items: center; gap: 5px; }
        .stars { color: #ffc107; /* Gold */ }
        .stars .material-icons { font-size: 18px; vertical-align: text-bottom; }
        .product-rating button { margin-left: auto; /* Push button to the right */ }


        /* --- Filters & Search --- */
        .filters-search-container {
             display: flex;
             flex-direction: column; /* Stack vertically on mobile */
             gap: 12px;
             margin-bottom: 20px;
             padding: 16px;
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
         .filters-search-container > div { width: 100%; } /* Full width for each filter item */
         .filters-search-container label { margin-bottom: 4px; font-size: 0.85em; }
         .filters-search-container select, .filters-search-container input[type="search"] {
             margin-bottom: 0;
             height: 42px; /* Slightly smaller height */
             padding: 10px;
         }
         .filters-search-container button {
             margin-top: 8px;
             height: 42px;
             width: 100%; /* Full width button */
         }

        /* --- Chat Styles --- */
        .chat-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease; }
        .chat-modal-content { background-color: #f4f4f4; margin: 0; padding: 0; border: none; width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column; max-height: 100%; }
        .chat-modal-header { background-color: #4CAF50; color: white; padding: 0 16px; height: 56px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex-shrink: 0; }
        .chat-modal-header h3 { margin: 0; font-size: 1.15em; font-weight: 500; flex-grow: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-close-btn { color: white; font-size: 30px; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0 10px; line-height: 1; margin-left: 10px; flex-shrink: 0; }
        .chat-close-btn .material-icons { font-size: 28px; vertical-align: middle; }


        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 12px; background-color: #f4f4f4; display: flex; flex-direction: column; }
        .chat-message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 80%; word-wrap: break-word; position: relative; font-size: 0.95em; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .chat-message.sender-customer { background-color: #DCF8C6; margin-left: auto; border-bottom-right-radius: 4px; align-self: flex-end; }
        .chat-message.sender-owner { background-color: #ffffff; margin-right: auto; border-bottom-left-radius: 4px; align-self: flex-start; }
        /* Removed police specific background, use owner style */
        .chat-message.sender-police { background-color: #e0f7fa; margin-right: auto; border-bottom-left-radius: 4px; align-self: flex-start; } /* Slightly different color maybe? */

        .chat-message.deleted { background-color: #f1f1f1; font-style: italic; color: #888; border: 1px dashed #ccc; padding: 6px 10px; box-shadow: none; }
        .chat-message.deleted .msg-time, .chat-message.deleted .delete-msg-btn { display: none; }

        .chat-message .msg-sender { display: none; } /* Simplify, maybe redundant */
        .chat-message .msg-time { font-size: 0.7em; color: #999; margin-top: 4px; text-align: right; display: block; padding-left: 10px; }
        .chat-message.sender-owner .msg-time, .chat-message.sender-police .msg-time { color: #aaa; }

        .delete-msg-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.05); border: none; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; text-align: center; font-size: 14px; color: #f44336; cursor: pointer; display: none; z-index: 1; opacity: 0.7; }
        .chat-message:hover .delete-msg-btn { display: block; }
        .chat-message.sender-customer .delete-msg-btn { right: -30px; }
        .chat-message.sender-owner .delete-msg-btn, .chat-message.sender-police .delete-msg-btn { left: -30px; }
        .delete-msg-btn:hover { background: #f44336; color: white; opacity: 1; }
        .delete-msg-btn .material-icons { font-size: 16px; vertical-align: middle; line-height: 24px; } /* Use icon */


        #chat-input-area { display: flex; gap: 8px; border-top: 1px solid #e0e0e0; padding: 8px 12px; background-color: #fff; flex-shrink: 0; align-items: flex-end; }
        #chat-input-area textarea { flex-grow: 1; resize: none; margin-bottom: 0; padding: 10px; border: 1px solid #ccc; border-radius: 20px; min-height: 42px; max-height: 100px; font-size: 1em; line-height: 1.3; background-color: #f9f9f9; }
        #chat-input-area button { flex-shrink: 0; margin: 0; height: 42px; width: 42px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: none; }
         #chat-input-area button .material-icons { font-size: 24px; } /* Send Icon */

        /* Chat List Styling */
        #owner-chats-section, #customer-chats-section { margin-top: 0; }
        #owner-chat-list, #customer-chat-list { list-style: none; padding: 0; margin: 0 -16px; /* Extend to edges */ max-height: none; overflow-y: visible; border: none; border-radius: 0; }
        #owner-chat-list li, #customer-chat-list li { padding: 12px 16px; border-bottom: 1px solid #e0e0e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: #fff; }
        #owner-chat-list li:last-child, #customer-chat-list li:last-child { border-bottom: none; }
        #owner-chat-list li:hover, #customer-chat-list li:hover { background-color: #f5f5f5; }
        #owner-chat-list .chat-list-info, #customer-chat-list .chat-list-info { flex-grow: 1; margin-right: 10px; overflow: hidden; }
        #owner-chat-list .customer-contact, #customer-chat-list .business-name { font-weight: 500; display: block; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #owner-chat-list .last-message, #customer-chat-list .last-message { font-size: 0.9em; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        #owner-chat-list .chat-time, #customer-chat-list .chat-time { font-size: 0.8em; color: #888; flex-shrink: 0; text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        #owner-chat-list .new-message-indicator, #customer-chat-list .new-message-indicator { background-color: #f44336; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: bold; display: inline-block; margin-top: 4px; }
        #owner-chat-status, #customer-chat-status { text-align: center; margin-top: 20px; color: #777; padding: 0 16px; }

        /* --- Admin Panel Styles --- */
        .admin-view table { font-size: 0.85em; }
        .admin-view th, .admin-view td { padding: 8px; }
        .admin-view td button { margin-top: 2px; margin-bottom: 2px; margin-right: 5px; } /* Space out admin buttons */
        .banned-user td { color: #999; text-decoration: line-through; background-color: #f5f5f5; }
        .banned-user button.unban-btn { background-color: #ff9800; color: white; }
        .banned-user button.unban-btn:hover { background-color: #fb8c00; }
        .admin-view .action-buttons-group { display: flex; flex-wrap: wrap; gap: 4px; align-items: center;}


        /* --- Feedback Styling --- */
        #ownerFeedbackLogTable td, #customerFeedbackLogTable td, #adminFeedbackTable td { vertical-align: top; font-size: 0.9em; }
        #ownerFeedbackLogTable .admin-reply, #customerFeedbackLogTable .admin-reply { font-style: italic; color: #1E88E5; white-space: pre-wrap; font-size: 0.9em; margin-top: 5px; display: block; padding: 5px; background: #e3f2fd; border-radius: 4px; }
        #adminFeedbackTable .submitter-info { font-size: 0.85em; color: #555; display: block; margin-top: 2px; }
        .feedback-status-new { color: #f44336; font-weight: bold; }
        .feedback-status-replied { color: #4CAF50; }
        .feedback-status-closed { color: grey; }

        /* --- Generic Modal Styling --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1500; /* Sit on top */
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            animation: fadeIn 0.3s ease;
        }
        .modal-content-box {
            background-color: #fefefe;
            margin: 10% auto; /* 10% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%; /* Could be more or less, depending on screen size */
            max-width: 500px; /* Maximum width */
            position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: #333;
        }
        .modal-close-btn {
            color: #aaa;
            /* float: right; */ /* Flexbox used instead */
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
            text-decoration: none;
        }
        .modal-body { padding-top: 15px; max-height: 60vh; overflow-y: auto; }
        .modal-actions { text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }

        /* --- Feedback Reply Modal (Uses Generic + Specifics) --- */
        #feedback-reply-modal .modal-content-box { max-width: 600px; }
        #feedback-reply-original-message { margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; font-style: italic; font-size: 0.9em; max-height: 100px; overflow-y: auto; }
        #feedback-reply-existing-replies { margin-bottom: 15px; max-height: 150px; overflow-y: auto; font-size: 0.9em; }
        #feedback-reply-existing-replies div { border-bottom: 1px dashed #ccc; padding-bottom: 8px; margin-bottom: 8px; }
        #feedback-reply-existing-replies strong { display: block; margin-bottom: 3px; color: #555; font-size: 0.9em; }
        #feedback-reply-modal form { padding: 0; box-shadow: none; margin-bottom: 0; }
        #feedback-reply-modal textarea { min-height: 100px; }

        /* --- Ratings Modal Styles --- */
        #ratings-modal .modal-content-box { max-width: 600px; }
        #ratings-modal h4 { margin-top: 0; color: #4CAF50; }
        #ratings-average { margin-bottom: 15px; font-weight: bold; }
        #ratings-list { margin-bottom: 20px; max-height: 200px; overflow-y: auto; }
        .rating-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .rating-item:last-child { border-bottom: none; }
        .rating-item .stars { margin-bottom: 5px; }
        .rating-item blockquote { margin: 5px 0 5px 15px; padding-left: 10px; border-left: 3px solid #eee; font-style: italic; color: #555; font-size: 0.95em; }
        .rating-item .rating-meta { font-size: 0.8em; color: #888; text-align: right; }
        #add-rating-form label { margin-top: 10px; }
        #add-rating-form .stars-input { display: flex; gap: 5px; margin-bottom: 10px; }
        #add-rating-form .stars-input .material-icons { font-size: 28px; color: #ccc; cursor: pointer; }
        #add-rating-form .stars-input .material-icons.selected { color: #ffc107; }
        #add-rating-form textarea { min-height: 60px; }

        /* --- Adverts Screen Styles (NEW) --- */
        #adverts-list {
            display: grid;
            grid-template-columns: 1fr; /* Single column layout */
            gap: 15px;
        }
        .advert-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            overflow: hidden;
        }
        .advert-card img.advert-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
            display: block;
        }
        .advert-card h4 {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            color: #4CAF50;
            border-bottom: none;
            padding: 0;
        }
        .advert-card p {
            margin: 0 0 10px 0;
            font-size: 0.95em;
            line-height: 1.4;
            color: #444;
            white-space: pre-wrap; /* Respect newlines in content */
        }
        .advert-meta {
            font-size: 0.8em;
            color: #777;
            text-align: right;
            border-top: 1px dashed #eee;
            padding-top: 8px;
            margin-top: 10px;
        }
        .advert-meta span { margin-left: 10px; }
        .advert-meta .uploader-type-admin { font-weight: bold; color: #f44336; }
        .advert-meta .uploader-type-owner { font-weight: bold; color: #2196F3; }


        /* --- Utility Classes --- */
        .error-message, .success-message, .warning-message {
             padding: 10px; border-radius: 4px; margin-bottom: 16px; text-align: center; font-size: 0.9em; font-weight: 500;
             min-height: 18px; /* Ensure it's visible even when empty */
        }
        .error-message:not(:empty), .success-message:not(:empty), .warning-message:not(:empty) {
             margin-top: 10px; /* Add margin only if there's content */
        }
        .error-message { color: #d32f2f; background-color: #ffcdd2; border: 1px solid #ef9a9a; }
        .success-message { color: #388E3C; background-color: #C8E6C9; border: 1px solid #a5d6a7; }
        .warning-message { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; } /* Bootstrap warning style */


        .form-toggle-link { display: block; text-align: center; margin-top: 20px; color: #1E88E5; cursor: pointer; font-size: 0.9em; }

        /* Toggleable Section (e.g., Change Password) */
        .toggleable-section { /* Renamed for broader use */
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden; /* Contain border-radius */
        }
        .toggleable-section .toggle-header {
            padding: 12px 16px;
            background-color: #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggleable-section .toggle-header h3 {
            margin: 0;
            font-size: 1.05em;
            color: #555;
            border: none;
            padding: 0;
        }
        .toggleable-section .toggle-header .material-icons {
            color: #757575;
            transition: transform 0.3s ease;
        }
        .toggleable-section .form-content {
            padding: 16px;
            display: none; /* JS controls visibility */
            border-top: 1px solid #e0e0e0;
        }
        .toggleable-section .form-content.is-visible {
            display: block;
        }
        .toggleable-section .toggle-header.is-open .material-icons {
            transform: rotate(180deg);
        }
        /* Apply class specifically */
        .change-password-section { /* Keep specific if needed */
            /* Can add specific overrides here if needed */
        }


        /* --- Floating Alert Button --- */
        #alert-button {
            position: fixed;
            bottom: 75px; /* Above bottom nav */
            right: 15px;
            width: 56px;
            height: 56px;
            background-color: #f44336; /* Red for alert */
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1400; /* Below modals, above content/footer */
            transition: transform 0.2s ease-in-out;
        }
        #alert-button:hover {
            transform: scale(1.1);
            background-color: #e53935;
        }
        #alert-button .material-icons {
            font-size: 28px;
        }

        /* --- Alert Modal Styling --- */
        #alert-modal .modal-content-box {
            max-width: 550px; /* Slightly wider */
        }
        #alert-modal .modal-body {
            max-height: 70vh; /* Allow more content */
        }
        #alert-modal label {
            font-weight: bold;
            margin-top: 10px;
            color: #444;
        }
        #alert-modal textarea {
            min-height: 100px;
            margin-bottom: 15px;
        }
        #alert-location-display {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            min-height: 30px;
            line-height: 1.4;
        }
        #alert-media-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: space-around; /* Space out buttons */
        }
        #alert-media-buttons button, #alert-media-buttons label.button-like { /* Include label */
            flex-basis: calc(50% - 10px); /* Two items per row approx */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 10px;
            text-transform: none; /* Less shouty */
        }
         #alert-media-buttons button .material-icons,
         #alert-media-buttons label.button-like .material-icons { /* Include label */
             font-size: 20px;
         }
         #alert-media-preview {
             margin-top: 10px;
             font-size: 0.85em;
             color: #666;
             min-height: 20px; /* Ensure space is reserved */
         }
        #alert-media-preview img, #alert-media-preview video, #alert-media-preview audio {
             max-width: 100%;
             max-height: 150px;
             display: block;
             margin-top: 5px;
             border: 1px solid #ccc;
             border-radius: 4px;
             object-fit: contain; /* Better fit for previews */
         }

        /* --- Alert Table Styles --- */
        .alert-table td {
             vertical-align: top;
             font-size: 0.9em;
        }
         .alert-table .alert-reason {
             white-space: pre-wrap; /* Respect newlines */
             max-width: 300px; /* Limit width */
             word-break: break-word;
         }
         .alert-table .alert-location {
             font-size: 0.85em;
             color: #666;
             white-space: nowrap;
         }
        .alert-table .alert-media {
             font-size: 0.85em;
             color: #888;
             font-style: italic;
         }
         .alert-table .alert-media img { /* Style for preview in table */
             max-width: 80px;
             max-height: 60px;
             margin-top: 5px;
             cursor: pointer; /* Indicate it might be clickable */
             border: 1px solid #ddd;
             border-radius: 3px;
         }
         .alert-status-new { font-weight: bold; color: #f44336; }
         .alert-status-viewed { color: #ff9800; }
         .alert-status-actioned { color: #4CAF50; }


        /* --- Original CSS Overrides/Removals --- */
        /* No need for .container padding/shadow */
        /* No need for h2 background/color (new style) */
        /* Header styling is replaced by .app-header */

        /* Specific Location Dropdown Label - NEW */
        label[for="specific-location-reg"], label[for="specific-location-filter"] {
            /* Style if needed */
        }

    </style>
</head>
<body>

<div id="app-container">

    <!-- App Header -->
    <header class="app-header">
        <div class="logo-title">
            <img src="wWano logo white bg.png" alt="Wano Logo"> <!-- Make sure this image exists -->
            <h1>Wano</h1>
        </div>
        <div id="user-status">
            <!-- Dynamic Login/Logout/User Info/Admin/Police Buttons -->
        </div>
    </header>

    <!-- Main Content Area (Scrollable) -->
    <main class="app-content">

        <!-- Authentication Screen -->
        <div id="auth-screen" class="app-screen"> <!-- Container for all auth forms -->

             <!-- Business Owner Login -->
            <div id="login-form" class="auth-form" style="display: none;"> <!-- Default hidden -->
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Business Sign In</h3>
                <div id="login-error" class="error-message"></div>
                <form id="loginForm">
                    <label for="loginEmail">Business Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your business email" required>
                    <label for="loginPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('loginPassword')">
                    </div>
                    <button type="submit" class="full-width">Sign In</button>
                </form>
                <p class="form-toggle-link" onclick="showRegisterForm()">Don't have a business account? Sign up</p>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                <p class="form-toggle-link" onclick="showCustomerLoginForm()">Switch to Customer Sign In</p>
                <p class="form-toggle-link" onclick="showAdminLoginForm()">Switch to Admin Sign In</p>
                <p class="form-toggle-link" onclick="showPoliceLoginForm()">Switch to Police Sign In</p> <!-- NEW -->
            </div>

            <!-- Business Owner Registration -->
            <div id="register-form" class="auth-form" style="display: none;">
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Business Sign Up</h3>
                <div id="register-error" class="error-message"></div>
                <form id="registerForm">
                    <label for="businessName">Business Name:</label>
                    <input type="text" id="businessName" required>
                    <label for="registerEmail">Business Email:</label>
                    <input type="email" id="registerEmail" required>
                    <label for="registerPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="registerPassword" placeholder="Min. 6 characters" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('registerPassword')">
                    </div>
                    <label for="phoneContact">Phone Contact:</label>
                    <input type="text" id="phoneContact" placeholder="e.g., 07xxxxxxxx" required>
                    <label for="ninNumber">NIN Number:</label>
                    <input type="text" id="ninNumber" required>
                    <label for="businessSectorReg">Business Sector:</label>
                    <select id="businessSectorReg" required><option value="" disabled selected>-- Select --</option></select>
                    <label for="district">District:</label>
                    <select id="district" required><option value="" disabled selected>-- Select --</option></select>
                    <div id="specific-location-container-reg" style="display: none; margin-top: 15px;">
                        <label for="specific-location-reg">Specific Area (e.g., Village/Parish):</label>
                        <select id="specific-location-reg"><option value="" selected>-- Select Specific Area --</option></select>
                    </div>
                    <label for="location">Further Location Detail (e.g., Trading Center):</label>
                    <input type="text" id="location" required>
                    <label for="ownerPhoto">Owner Photo:</label>
                    <input type="file" id="ownerPhoto" accept="image/*" required>
                    <button type="submit" class="full-width">Sign Up</button>
                </form>
                <p class="form-toggle-link" onclick="showLoginForm()">Already have a business account? Sign in</p>
                 <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                <p class="form-toggle-link" onclick="showCustomerLoginForm()">Switch to Customer Sign In</p>
                <p class="form-toggle-link" onclick="showAdminLoginForm()">Switch to Admin Sign In</p>
                <p class="form-toggle-link" onclick="showPoliceLoginForm()">Switch to Police Sign In</p> <!-- NEW -->
            </div>

            <!-- Customer Login -->
            <div id="customer-login-form" class="auth-form" style="display: none;">
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Customer Sign In</h3>
                <div id="customer-login-error" class="error-message"></div>
                <form id="customerLoginForm">
                    <label for="customerLoginIdentifier">Email or Phone Number:</label>
                    <input type="text" id="customerLoginIdentifier" placeholder="Enter your email or phone" required>
                    <label for="customerLoginPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="customerLoginPassword" placeholder="Enter your password" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('customerLoginPassword')">
                    </div>
                    <button type="submit" class="full-width">Sign In</button>
                </form>
                <p class="form-toggle-link" onclick="showCustomerRegisterForm()">Don't have an account? Sign up</p>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                <p class="form-toggle-link" onclick="showLoginForm()">Switch to Business Sign In</p>
                <p class="form-toggle-link" onclick="showAdminLoginForm()">Switch to Admin Sign In</p>
                <p class="form-toggle-link" onclick="showPoliceLoginForm()">Switch to Police Sign In</p> <!-- NEW -->
            </div>

            <!-- Customer Registration -->
            <div id="customer-register-form" class="auth-form" style="display: none;">
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Customer Sign Up</h3>
                <div id="customer-register-error" class="error-message"></div>
                <form id="customerRegisterForm">
                    <label for="customerRegisterName">Full Name:</label>
                    <input type="text" id="customerRegisterName" placeholder="Enter your full name" required>
                    <label for="customerRegisterEmail">Email Address:</label>
                    <input type="email" id="customerRegisterEmail" placeholder="Enter a valid email" required>
                    <label for="customerRegisterPhone">Phone Number:</label>
                    <input type="text" id="customerRegisterPhone" placeholder="e.g., 07xxxxxxxx" required>
                    <label for="customerRegisterPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="customerRegisterPassword" placeholder="Create a password (min. 6 characters)" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('customerRegisterPassword')">
                    </div>
                    <button type="submit" class="full-width">Sign Up</button>
                </form>
                <p class="form-toggle-link" onclick="showCustomerLoginForm()">Already have an account? Sign in</p>
                 <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                 <p class="form-toggle-link" onclick="showLoginForm()">Switch to Business Sign In</p>
                <p class="form-toggle-link" onclick="showAdminLoginForm()">Switch to Admin Sign In</p>
                <p class="form-toggle-link" onclick="showPoliceLoginForm()">Switch to Police Sign In</p> <!-- NEW -->
            </div>

            <!-- Admin Login Form -->
            <div id="admin-login-form" class="auth-form" style="display: none;">
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Admin Sign In</h3>
                 <div id="admin-login-error" class="error-message"></div>
                 <form id="adminLoginForm">
                    <label for="adminLoginEmail">Admin Email:</label>
                    <input type="email" id="adminLoginEmail" required>
                    <label for="adminLoginPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="adminLoginPassword" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('adminLoginPassword')">
                    </div>
                    <button type="submit" class="full-width info">Sign In</button>
                 </form>
                 <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                 <p class="form-toggle-link" onclick="showCustomerLoginForm()">Switch to Customer Sign In</p>
                 <p class="form-toggle-link" onclick="showLoginForm()">Switch to Business Sign In</p>
                 <p class="form-toggle-link" onclick="showPoliceLoginForm()">Switch to Police Sign In</p> <!-- NEW -->
             </div>

            <!-- Police Login Form (NEW) -->
            <div id="police-login-form" class="auth-form" style="display: none;">
                <h3 style="text-align:center; color:#444; margin-bottom:20px;">Police Sign In</h3>
                 <div id="police-login-error" class="error-message"></div>
                 <form id="policeLoginForm">
                    <label for="policeLoginId">Police ID / Badge Number:</label>
                    <input type="text" id="policeLoginId" required>
                    <label for="policeLoginPassword">Password:</label>
                    <div class="password-wrapper">
                        <input type="password" id="policeLoginPassword" required>
                        <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('policeLoginPassword')">
                    </div>
                    <button type="submit" class="full-width warning">Sign In</button> <!-- Warning color for police -->
                 </form>
                 <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                 <p class="form-toggle-link" onclick="showCustomerLoginForm()">Switch to Customer Sign In</p>
                 <p class="form-toggle-link" onclick="showLoginForm()">Switch to Business Sign In</p>
                 <p class="form-toggle-link" onclick="showAdminLoginForm()">Switch to Admin Sign In</p>
             </div>

        </div> <!-- End Auth Screen -->


        <!-- Owner Dashboard Screen -->
        <div id="owner-dashboard-screen" class="app-screen">
             <p id="owner-details" style="text-align: left; margin: -10px 0 16px 0; color: #555; font-size: 0.9em; background: #fff; padding: 8px; border-radius: 4px;"></p>

              <!-- Received Orders Section -->
             <h3 class="section-header">Received Orders</h3>
             <div id="owner-orders-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                 <table id="ownerOrdersTable">
                     <thead><tr><th>Customer</th><th>Contact</th><th>Time</th><th>Items for You</th><th>Status</th></tr></thead>
                     <tbody><!-- Orders loaded by JS --></tbody>
                 </table>
             </div>

             <!-- Product Upload Section -->
             <h3 class="section-header">Upload New Product</h3>
             <form id="productForm">
                 <label for="productName">Product Name:</label>
                 <input type="text" id="productName" placeholder="E.g., Fresh Mangoes (Kg)" required>
                 <label for="productDescription">Product Description:</label>
                 <textarea id="productDescription" placeholder="Brief description" required rows="3"></textarea>
                 <label for="productPrice">Price (UGX):</label>
                 <input type="number" id="productPrice" placeholder="Enter price" required min="0">
                 <label for="productImage">Product Image:</label>
                 <input type="file" id="productImage" accept="image/*" required>
                 <button type="submit">Add Product</button>
             </form>

             <!-- Your Products Table -->
             <h3 class="section-header">Your Products</h3>
              <div id="owner-products-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                 <table class="product-table" id="ownerProductTable">
                     <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead>
                     <tbody><!-- Products loaded by JS --></tbody>
                 </table>
             </div>

            <!-- Owner Advert Upload Section -->
            <h3 class="section-header">Upload Announcement/Advert</h3>
            <form id="ownerAdvertForm">
                <div id="owner-advert-msg" class="success-message"></div> <!-- For success/error -->
                <label for="ownerAdvertTitle">Title:</label>
                <input type="text" id="ownerAdvertTitle" required>
                <label for="ownerAdvertContent">Content:</label>
                <textarea id="ownerAdvertContent" rows="4" required></textarea>
                <label for="ownerAdvertImage">Image (Optional):</label>
                <input type="file" id="ownerAdvertImage" accept="image/*">
                <p style="font-size:0.85em; color:#666; margin-top:-10px; margin-bottom:15px;"><i>(This will be visible to Customers)</i></p>
                <button type="submit">Upload Advert</button>
            </form>

        </div> <!-- End Owner Dashboard Screen -->


        <!-- Customer Home/Products Screen -->
        <div id="customer-home-screen" class="app-screen">
            <!-- Filters & Search Section -->
            <div class="filters-search-container">
                <div>
                    <label for="district-filter">Filter by District:</label>
                    <select id="district-filter"> <option value="">-- All Districts --</option> </select>
                </div>
                <div id="specific-location-container-filter" style="display: none;">
                    <label for="specific-location-filter">Filter by Specific Area:</label>
                    <select id="specific-location-filter"><option value="">-- All Areas in District --</option></select>
                </div>
                <div>
                    <label for="sector-filter">Filter by Business Sector:</label>
                    <select id="sector-filter"> <option value="">-- All Sectors --</option> </select>
                </div>
                <div>
                   <label for="product-search-input">Search Products:</label>
                   <input type="search" id="product-search-input" placeholder="Enter product name...">
                </div>
                <button type="button" onclick="loadFilteredProducts()">Load/Filter</button>
            </div>

            <h3 class="section-header">Products for Sale</h3>
            <div id="customer-product-status" style="text-align: center; margin-top: 15px;">
                <p id="customer-product-placeholder">Select filters and click 'Load/Filter' to view items.</p>
            </div>
            <div id="customer-product-list">
                <!-- Product cards will be displayed here -->
            </div>

            <!-- Current Order Section -->
            <div id="currentOrderSection" style="display: none; margin-top: 20px;">
                <h3 class="section-header">Your Current Order</h3>
                 <div class="table-responsive-wrapper">
                     <table id="currentOrderTable">
                         <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th>Act</th></tr></thead>
                         <tbody><!-- Order items loaded by JS --></tbody>
                     </table>
                 </div>
                <div class="total-cost"> Total: UGX <span id="orderTotalCost">0</span> </div>
                <form id="orderForm" style="box-shadow:none; padding: 0;"> <!-- No extra box for single button -->
                    <p><i>Note: Business owner(s) will contact you to confirm.</i></p>
                    <button type="submit" class="full-width">Request Order</button>
                </form>
            </div>

        </div> <!-- End Customer Home Screen -->

        <!-- Chat List Screen (Used by both Owner & Customer) -->
        <div id="chat-list-screen" class="app-screen">
            <h3 class="section-header">Your Chats</h3>
            <!-- Owner Chats Section -->
            <div id="owner-chats-section" style="display: none;">
                <p id="owner-chat-status" style="text-align: center; margin-top: 10px; color: #555;">Loading chats...</p>
                <ul id="owner-chat-list"></ul>
            </div>
            <!-- Customer Chats Section -->
            <div id="customer-chats-section" style="display: none;">
                <p id="customer-chat-status" style="text-align: center; margin-top: 10px; color: #555;">Loading chats...</p>
                <ul id="customer-chat-list"></ul>
            </div>
        </div> <!-- End Chat List Screen -->

         <!-- Adverts Screen -->
        <div id="adverts-screen" class="app-screen">
            <h3 class="section-header">Announcements & Adverts</h3>
            <div id="adverts-status" style="text-align: center; margin-top: 10px; color: #555;">Loading...</div>
            <div id="adverts-list">
                <!-- Advert cards will be displayed here -->
            </div>
        </div> <!-- End Adverts Screen -->

        <!-- Profile/Settings Screen (Used by Owner & Customer) -->
        <div id="profile-screen" class="app-screen">
             <h3 class="section-header" id="profile-screen-title">Profile & Settings</h3>

             <!-- Feedback Section (Submission Form - Customer Only) -->
             <div id="customer-feedback-submit-section" style="display:none;">
                 <h3 class="section-header">Submit General Feedback</h3>
                 <form id="feedbackForm">
                     <p><i>Use this form for general feedback about the app or services. To rate/comment on a specific product, use the 'Ratings & Comments' button on the product card (Home screen).</i></p>
                     <label for="feedbackCustomerName">Your Name:</label>
                     <input type="text" id="feedbackCustomerName" readonly disabled> <!-- Pre-fill -->
                     <label for="feedbackText">Your Feedback:</label>
                     <textarea id="feedbackText" required rows="3" placeholder="Enter your general feedback here..."></textarea>
                     <button type="submit">Submit General Feedback</button>
                 </form>
             </div>

            <!-- Feedback Log Section (Owner) -->
            <div id="owner-feedback-log-section" style="display: none;">
                <h3 class="section-header">Your Submitted General Feedback</h3>
                <div id="owner-feedback-status" style="text-align: center; margin-bottom: 10px;"></div>
                 <div class="table-responsive-wrapper">
                    <table id="ownerFeedbackLogTable">
                        <thead><tr><th>Feedback</th><th>Submitted</th><th>Admin Reply</th><th>Status</th></tr></thead>
                        <tbody><!-- Log loaded by JS --></tbody>
                    </table>
                </div>
            </div>

             <!-- Feedback Log Section (Customer) -->
            <div id="customer-feedback-log-section" style="display: none;">
                 <h3 class="section-header">Your Submitted General Feedback Log</h3>
                 <div id="customer-feedback-status" style="text-align: center; margin-bottom: 10px;"></div>
                 <div class="table-responsive-wrapper">
                     <table id="customerFeedbackLogTable">
                        <thead><tr><th>Feedback</th><th>Submitted</th><th>Admin Reply</th><th>Status</th></tr></thead>
                        <tbody><!-- Log loaded by JS --></tbody>
                     </table>
                 </div>
            </div>

             <!-- Change Password Section (Owner) -->
            <div id="owner-change-password-section-wrapper" class="toggleable-section change-password-section" style="display:none;">
                <div class="toggle-header" onclick="toggleSectionVisibility(this, 'owner-change-password-content')">
                    <h3>Change Your Password</h3>
                    <i class="material-icons">expand_more</i>
                </div>
                <div id="owner-change-password-content" class="form-content">
                    <div id="owner-change-pwd-error" class="error-message"></div>
                    <div id="owner-change-pwd-success" class="success-message"></div>
                    <form id="ownerChangePasswordForm" style="padding:0; box-shadow:none;">
                        <label for="ownerCurrentPassword">Current Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="ownerCurrentPassword" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('ownerCurrentPassword')">
                        </div>
                        <label for="ownerNewPassword">New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="ownerNewPassword" placeholder="Min. 6 characters" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('ownerNewPassword')">
                        </div>
                        <label for="ownerConfirmPassword">Confirm New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="ownerConfirmPassword" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('ownerConfirmPassword')">
                        </div>
                        <button type="submit">Change Password</button>
                    </form>
                </div>
            </div>

            <!-- Change Password Section (Customer) -->
            <div id="customer-change-password-section-wrapper" class="toggleable-section change-password-section" style="display:none;">
                 <div class="toggle-header" onclick="toggleSectionVisibility(this, 'customer-change-password-content')">
                    <h3>Change Your Password</h3>
                    <i class="material-icons">expand_more</i>
                 </div>
                <div id="customer-change-password-content" class="form-content">
                    <div id="customer-change-pwd-error" class="error-message"></div>
                    <div id="customer-change-pwd-success" class="success-message"></div>
                    <form id="customerChangePasswordForm" style="padding:0; box-shadow:none;">
                        <label for="customerCurrentPassword">Current Password:</label>
                         <div class="password-wrapper">
                             <input type="password" id="customerCurrentPassword" required>
                             <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('customerCurrentPassword')">
                         </div>
                        <label for="customerNewPassword">New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="customerNewPassword" placeholder="Min. 6 characters" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('customerNewPassword')">
                        </div>
                        <label for="customerConfirmPassword">Confirm New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="customerConfirmPassword" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('customerConfirmPassword')">
                        </div>
                        <button type="submit">Change Password</button>
                    </form>
                </div>
            </div>

             <!-- Past Orders Section (Customer Only) -->
             <div id="customer-past-orders-section" style="display: none;">
                 <h3 class="section-header">Your Past Order Requests</h3>
                 <div id="customer-orders-status" style="text-align: center; margin-bottom: 10px;"></div>
                 <div class="table-responsive-wrapper">
                     <table id="ordersTable">
                         <thead><tr><th>Items</th><th>Total</th><th>Time</th><th>Status</th></tr></thead>
                         <tbody><!-- Orders loaded by JS --></tbody>
                     </table>
                 </div>
             </div>

        </div> <!-- End Profile Screen -->

        <!-- Police Alerts Screen (NEW) -->
        <div id="police-alerts-screen" class="app-screen">
            <h3 class="section-header">Received Alerts</h3>
            <div id="police-alerts-status" style="text-align: center; margin-bottom: 10px;"></div>
            <div class="table-responsive-wrapper">
                <table id="policeAlertsTable" class="alert-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Sender</th>
                            <th>Reason</th>
                            <th>Location</th>
                            <th>Media</th>
                            <th>Status</th>
                            <!-- <th>Actions</th> -->
                        </tr>
                    </thead>
                    <tbody><!-- Alerts loaded by JS --></tbody>
                </table>
            </div>
        </div> <!-- End Police Alerts Screen -->


        <!-- Admin Panel Screen -->
        <div id="admin-panel-screen" class="app-screen admin-view">
            <h3 class="section-header">Admin Control Panel</h3>

            <!-- Manage Police Accounts Section (NEW) -->
            <h3 class="section-header">Manage Police Accounts</h3>
            <form id="createPoliceAccountForm">
                <div id="create-police-msg" class="success-message"></div>
                <label for="policeName">Officer Name:</label>
                <input type="text" id="policeName" required>
                <label for="policeId">Police ID / Badge No:</label>
                <input type="text" id="policeId" placeholder="Must be unique" required>
                <label for="policePassword">Password:</label>
                <div class="password-wrapper">
                    <input type="password" id="policePassword" placeholder="Min. 6 characters" required>
                    <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('policePassword')">
                </div>
                <button type="submit" class="info">Create Police Account</button>
            </form>
            <div id="admin-police-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                <table id="adminPoliceAccountsTable">
                    <thead><tr><th>Name</th><th>Police ID</th><th>Actions</th></tr></thead>
                    <tbody><!-- Police accounts loaded by JS --></tbody>
                </table>
            </div>
            <hr>

            <!-- Manage Received Alerts Section (NEW) -->
            <h3 class="section-header">Manage Received Alerts</h3>
            <div id="admin-alerts-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                <table id="adminAlertsTable" class="alert-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Sender</th>
                            <th>Reason</th>
                            <th>Location</th>
                            <th>Media</th>
                            <th>Status</th>
                            <!-- <th>Actions</th> --> <!-- Add actions later if needed -->
                        </tr>
                    </thead>
                    <tbody><!-- Alerts loaded by JS --></tbody>
                </table>
            </div>
            <hr>

            <!-- Business Owners Table -->
            <h3 class="section-header">Manage Business Owners</h3>
             <div id="admin-owners-status" style="text-align: center; margin-bottom: 10px;"></div>
            <div class="table-responsive-wrapper">
                <table id="adminBusinessOwnersTable">
                    <thead><tr><th>Business</th><th>Contact</th><th>District/Area</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody><!-- Owners loaded by JS --></tbody>
                </table>
            </div>
            <hr>

            <!-- Customers Table -->
            <h3 class="section-header">Manage Customers</h3>
            <div id="admin-customers-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                <table id="adminCustomersTable">
                    <thead><tr><th>Name</th><th>Contact</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody><!-- Customers loaded by JS --></tbody>
                </table>
            </div>
            <hr>

            <!-- Feedback Management Table -->
            <h3 class="section-header">Manage General Feedback</h3>
            <div id="admin-feedback-status" style="text-align: center; margin-bottom: 10px;"></div>
             <div class="table-responsive-wrapper">
                <table id="adminFeedbackTable">
                    <thead><tr><th>Submitter</th><th>Feedback</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody><!-- Feedback loaded by JS --></tbody>
                </table>
             </div>
             <hr>

            <!-- Admin Upload Advert Section -->
             <h3 class="section-header">Upload Announcement/Advert</h3>
             <form id="adminAdvertForm">
                 <div id="admin-advert-msg" class="success-message"></div> <!-- For success/error -->
                 <label for="adminAdvertTitle">Title:</label>
                 <input type="text" id="adminAdvertTitle" required>
                 <label for="adminAdvertContent">Content:</label>
                 <textarea id="adminAdvertContent" rows="4" required></textarea>
                 <label for="adminAdvertImage">Image (Optional):</label>
                 <input type="file" id="adminAdvertImage" accept="image/*">
                 <label for="adminAdvertAudience">Target Audience:</label>
                 <select id="adminAdvertAudience" required>
                     <option value="all" selected>All Users</option>
                     <option value="customers">Customers Only</option>
                     <option value="owners">Business Owners Only</option>
                     <option value="police">Police Only</option> <!-- NEW Target -->
                 </select>
                 <button type="submit" class="info">Upload Advert</button>
             </form>
             <hr>

            <!-- Admin Change Password Section -->
            <div id="admin-change-password-section-wrapper" class="toggleable-section change-password-section">
                <div class="toggle-header" onclick="toggleSectionVisibility(this, 'admin-change-password-content')">
                    <h3>Change Admin Password (Session Only)</h3>
                    <i class="material-icons">expand_more</i>
                </div>
                <div id="admin-change-password-content" class="form-content">
                    <p style="font-size:0.85em; color:orange;"><i>Warning: This change only lasts for the current browser session due to insecure client-side implementation.</i></p>
                    <div id="admin-change-pwd-error" class="error-message"></div>
                    <div id="admin-change-pwd-success" class="success-message"></div>
                    <form id="adminChangePasswordForm" style="padding:0; box-shadow:none;">
                        <label for="adminCurrentPassword">Current Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="adminCurrentPassword" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('adminCurrentPassword')">
                        </div>
                        <label for="adminNewPassword">New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="adminNewPassword" placeholder="Min. 6 characters" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('adminNewPassword')">
                        </div>
                        <label for="adminConfirmPassword">Confirm New Password:</label>
                        <div class="password-wrapper">
                            <input type="password" id="adminConfirmPassword" required>
                            <input type="checkbox" class="password-toggle" onclick="togglePasswordVisibility('adminConfirmPassword')">
                        </div>
                        <button type="submit" class="info">Change Admin Password</button>
                    </form>
                </div>
            </div>

        </div><!-- End Admin Panel Screen -->


    </main> <!-- End App Content -->


    <!-- Bottom Navigation -->
    <footer class="app-footer" id="bottom-nav" style="display: none;"> <!-- Initially hidden -->
        <!-- Standard Nav Items (Owner/Customer) -->
        <button class="nav-item" id="nav-home" onclick="navigateTo('home')">
            <i class="material-icons">storefront</i> <!-- Or home -->
            <span>Home</span>
        </button>
        <button class="nav-item" id="nav-chats" onclick="navigateTo('chats')">
            <i class="material-icons">chat_bubble_outline</i>
             <span>Chats</span>
         </button>
         <button class="nav-item" id="nav-adverts" onclick="navigateTo('adverts')">
             <i class="material-icons">campaign</i>
             <span>Adverts</span>
         </button>
         <button class="nav-item" id="nav-profile" onclick="navigateTo('profile')">
             <i class="material-icons">person_outline</i>
             <span>Profile</span>
         </button>
         <!-- Police Nav Item (NEW) -->
         <button class="nav-item" id="nav-police-alerts" onclick="navigateTo('police-alerts')" style="display: none;">
             <i class="material-icons">security</i> <!-- Or local_police, report -->
             <span>Alerts</span>
         </button>
         <!-- Admin Nav Item -->
          <button class="nav-item" id="nav-admin" onclick="navigateTo('admin')" style="display: none;">
             <i class="material-icons">admin_panel_settings</i>
             <span>Admin</span>
         </button>
    </footer>

    <!-- Floating Alert Button (NEW) -->
    <button id="alert-button" title="Send Alert" onclick="openAlertModal()">
        <i class="material-icons">priority_high</i> <!-- Or warning, report_problem -->
    </button>

</div> <!-- End App Container -->


<!-- Modals (Remain outside the main scroll area) -->

<!-- Chat Modal -->
<div id="chat-modal" class="chat-modal"> <!-- Uses full screen style -->
    <div class="chat-modal-content">
        <div class="chat-modal-header">
            <h3 id="chat-modal-title">Chat</h3>
            <button class="chat-close-btn" onclick="closeChatModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div id="chat-messages">
            <!-- Messages appear here -->
        </div>
        <div id="chat-input-area">
            <textarea id="chat-message-input" placeholder="Type your message..." rows="1"></textarea> <!-- Start with 1 row -->
            <button id="chat-send-btn" class="secondary" onclick="sendMessage()">
                 <i class="material-icons">send</i>
            </button>
        </div>
         <div id="chat-customer-details" style="display: none;"></div> <!-- Kept -->
    </div>
</div>

<!-- Feedback Reply Modal -->
<div id="feedback-reply-modal" class="modal-overlay">
    <div class="modal-content-box">
        <div class="modal-header">
            <h3 id="feedback-reply-modal-title">Reply to Feedback</h3>
             <button class="modal-close-btn" onclick="closeFeedbackReplyModal()">
                 &times; <!-- HTML entity for X -->
             </button>
        </div>
        <div class="modal-body">
            <div id="feedback-reply-original-message"></div>
            <div id="feedback-reply-existing-replies"></div>
            <form id="feedbackReplyForm">
                <input type="hidden" id="feedbackReplyId">
                <label for="feedbackReplyText">Your Reply:</label>
                <textarea id="feedbackReplyText" rows="4" required placeholder="Type your reply..."></textarea>
                 <div class="modal-actions">
                     <button type="button" class="secondary small" onclick="closeFeedbackReplyModal()">Cancel</button>
                     <button type="submit" class="small">Send Reply</button>
                 </div>
            </form>
         </div>
    </div>
</div>

<!-- Ratings & Comments Modal -->
<div id="ratings-modal" class="modal-overlay">
    <div class="modal-content-box">
        <div class="modal-header">
            <h3 id="ratings-modal-title">Product Ratings & Comments</h3>
            <button class="modal-close-btn" onclick="closeRatingsModal()">
                &times;
            </button>
        </div>
        <div class="modal-body">
            <h4 id="ratings-product-name">Product Name</h4>
            <div id="ratings-average">Average Rating: <span class="stars"></span> (<span id="ratings-count">0</span> ratings)</div>

            <h4>Existing Ratings & Comments:</h4>
            <div id="ratings-list">
                <p>Loading ratings...</p>
                <!-- Rating items will be inserted here -->
            </div>

            <hr>

            <h4>Add Your Rating & Comment:</h4>
            <form id="add-rating-form">
                <input type="hidden" id="rating-target-id">
                <input type="hidden" id="rating-target-type" value="product"> <!-- Hardcoded for now -->

                <label for="rating-value">Your Rating:</label>
                <div class="stars-input" id="rating-value-stars">
                    <i class="material-icons" data-value="1">star_border</i>
                    <i class="material-icons" data-value="2">star_border</i>
                    <i class="material-icons" data-value="3">star_border</i>
                    <i class="material-icons" data-value="4">star_border</i>
                    <i class="material-icons" data-value="5">star_border</i>
                </div>
                <input type="hidden" id="rating-value" required> <!-- Hidden input stores the actual value -->

                <label for="rating-comment">Your Comment (Optional):</label>
                <textarea id="rating-comment" rows="3" placeholder="Share your experience..."></textarea>

                <div id="add-rating-error" class="error-message"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary small" onclick="closeRatingsModal()">Cancel</button>
                    <button type="submit" class="small">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Alert Reporting Modal (Updated for media handling) -->
<div id="alert-modal" class="modal-overlay">
    <div class="modal-content-box">
        <div class="modal-header">
            <h3>Report an Alert</h3>
            <button class="modal-close-btn" onclick="closeAlertModal()">
                &times;
            </button>
        </div>
        <div class="modal-body">
            <form id="alertForm" style="padding:0; box-shadow:none; margin-bottom:0;">
                <label for="alert-reason">Reason for Alert:</label>
                <textarea id="alert-reason" rows="4" required placeholder="Describe the situation..."></textarea>

                <label>Attach Media (Optional):</label>
                <div id="alert-media-buttons">
                    <!-- Add onclick handlers -->
                    <button type="button" class="info small" onclick="recordVideo()">
                        <i class="material-icons">videocam</i> Record Video
                    </button>
                    <button type="button" class="info small" onclick="recordAudio()">
                        <i class="material-icons">mic</i> Record Audio
                    </button>
                    <button type="button" class="info small" onclick="captureImage()">
                        <i class="material-icons">photo_camera</i> Take Photo
                    </button>
                     <!-- Change button to label, add onchange to input -->
                     <label for="alert-image-upload" class="button-like info small" style="margin:0; flex-basis: calc(50% - 10px); height: auto; cursor: pointer;">
                         <i class="material-icons">upload_file</i> Upload Image
                     </label>
                     <input type="file" id="alert-image-upload" accept="image/*" style="display: none;" onchange="handleAlertImageUpload(event)">
                </div>
                <div id="alert-media-preview">
                    <!-- Media previews will appear here -->
                </div>
                <!-- This hidden input will store the media data (e.g., Data URL for images) -->
                <input type="hidden" id="alert-media-data" value="">

                <label for="alert-location-display">Your Location:</label>
                <div id="alert-location-display">Fetching location...</div>
                <button type="button" class="secondary small" onclick="getDeviceLocation()" style="margin-bottom: 15px;">
                    <i class="material-icons" style="font-size: 18px; vertical-align: middle;">refresh</i> Refresh Location
                </button>
                <input type="hidden" id="alert-location-coords" value=""> <!-- Store lat,lon -->

                <div id="alert-send-error" class="error-message"></div>
                <div class="modal-actions">
                    <button type="button" class="secondary small" onclick="closeAlertModal()">Cancel</button>
                    <button type="submit" class="danger">Send Alert</button> <!-- Submit button for the form -->
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    // --- Constants ---
    const USERS_KEY = 'wano_business_users_v7'; // Incremented version
    const CUSTOMER_ACCOUNTS_KEY = 'wano_customer_accounts_v3'; // Incremented version
    const POLICE_ACCOUNTS_KEY = 'wano_police_accounts_v1'; // NEW Police accounts
    const PRODUCTS_KEY = 'wano_products_v7';
    const CURRENT_USER_KEY = 'wano_currentBusinessUser_v7';
    const CURRENT_CUSTOMER_KEY = 'wano_currentCustomer_v3';
    const CURRENT_POLICE_USER_KEY = 'wano_currentPoliceUser_v1'; // NEW Police login state
    const ORDERS_KEY = 'wano_orders_v7';
    const FEEDBACK_KEY_V2 = 'wano_feedback_v7';
    const RATINGS_COMMENTS_KEY = 'wano_ratings_comments_v3';
    const CHATS_KEY = 'wano_chats_v4';
    const WANO_ADVERTS_KEY = 'wano_adverts_v2';
    const ALERTS_KEY = 'wano_alerts_v1'; // NEW Alerts storage

    let ADMIN_EMAIL = 'admin@wano.app'; // ** INSECURE **
    let ADMIN_PASSWORD = 'adminpassword'; // ** INSECURE **

    const DEFAULT_OWNER_PHOTO = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICA8cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHJ4PSIyMCIgcnk9IjIwIiBmaWxsPSIjY2NjIj48L3JlY3Q+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjIwIiBmaWxsPSIjNzc3Ij4/PC90ZXh0Pgo8L3N2Zz4=';
    const ugandanDistricts = [ "Abim", "Adjumani", "Agago", "Alebtong", "Amolatar", "Amudat", "Amuria", "Amuru", "Apac", "Arua", "Budaka", "Bududa", "Bugiri", "Bugweri", "Buhweju", "Buikwe", "Bukedea", "Bukomansimbi", "Bukwo", "Bulambuli", "Buliisa", "Bundibugyo", "Bunyangabu", "Bushenyi", "Busia", "Butaleja", "Butambala", "Butebo", "Buvuma", "Buyende", "Dokolo", "Gomba", "Gulu", "Hoima", "Ibanda", "Iganga", "Isingiro", "Jinja", "Kaabong", "Kabale", "Kabarole", "Kaberamaido", "Kagadi", "Kakumiro", "Kalaki", "Kalangala", "Kaliro", "Kalungu", "Kampala", "Kamuli", "Kamwenge", "Kanungu", "Kapchorwa", "Kapelebyong", "Karenga", "Kasanda", "Kasese", "Katakwi", "Kayunga", "Kazo", "Kibaale", "Kiboga", "Kibuku", "Kikuube", "Kiruhura", "Kiryandongo", "Kisoro", "Kitagwenda", "Kitgum", "Koboko", "Kole", "Kotido", "Kumi", "Kwania", "Kween", "Kyankwanzi", "Kyegegwa", "Kyenjojo", "Kyotera", "Lamwo", "Lira", "Luuka", "Luwero", "Lwengo", "Lyantonde", "Madi-Okollo", "Manawa", "Maracha", "Masaka", "Masindi", "Mayuge", "Mbale", "Mbarara", "Mitooma", "Mityana", "Moroto", "Moyo", "Mpigi", "Mubende", "Mukono", "Nabilatuk", "Nakapiripirit", "Nakaseke", "Nakasongola", "Namayingo", "Namisindwa", "Namutumba", "Napak", "Nebbi", "Ngora", "Ntoroko", "Ntungamo", "Nwoya", "Obongi", "Omoro", "Otuke", "Oyam", "Pader", "Pakwach", "Pallisa", "Rakai", "Rubanda", "Rubirizi", "Rukiga", "Rukungiri", "Rwampara", "Sembabule", "Serere", "Sheema", "Sironko", "Soroti", "Terego", "Tororo", "Wakiso", "Yumbe", "Zombo" ].sort();
    const businessSectors = [ "Agriculture", "Education", "Hotels", "Taxi drivers", "Boda-boda riders", "Sailors", "Shopkeeper", "Hospitals", "Electricians", "Vehicle sales", "Property masters", "Repair and construction", "Fashion", "Commercial equipment and tools", "Furniture" ].sort();
    const districtSpecificLocations = {
        "Kalangala": [ "View All Islands/Villages", "Bugala Island", "Bubeke Island", "Bufumira Island", "Bukasa Island", "Buyovu Island", "Buvu Island", "Damba Island", "Funve Island", "Jana Island", "Kkome Island", "Lulamba Island", "Luwaji Island", "Mweza Island", "Nkose Island", "Sserinya Island", "Jaana", "Bugaba", "Bunyama", "Bujumba", "Mweena", "Kacungwa", "Kisaba", "Lutoboka Central", "Banda", "Lutoboka", "Mulabana", "Kasekulo", "Kagoonya", "Kaazi", "Ntuuwa", "Lujjabwa", "Kiswa", "Kalayilo", "Kakyanga", "Buggala Central", "Buswa", "Kaaya", "Kyagalanyi", "Bumanji", "Kyamuswa Central", "Bukakata", "Lwabaswa", "Kibanga", "Bukibanga", "Lwazi", "Bubindhe", "Bukwaya", "Bubeke Central", "Lyamugenyi", "Gab Kibanba", "Lukuba", "Butulume", "Kasamba", "Kiwumulo", "Bukopi", "Kyeserwa", "Misonzi", "Nalukonge", "Bufumira Central", "Kaazi", "Semawundo", "Lwabaala", "Kitobo", "Bunjaako", "Buyange", "Bwamba", "Nkose", "Bukasa Central", "Kande", "Mwena", "Buziga", "Mbuule", "Kagulu", "Namisoke", "Kikwayu", "Buyovu Central", "Jana", "Lujaaba", "Buyaga", "Lulindi", "Bbeta", "Kachanga", "Last Island Area Placeholder" ],
        "Kampala": [ "View All Divisions/Parishes", "Central Division", "Kawempe Division", "Makindye Division", "Nakawa Division", "Rubaga Division", "Kololo", "Nakasero", "Old Kampala", "Bukesa", "Kisenyi I", "Kisenyi II", "Mengo", "Namirembe", "Wandegeya", "Bwaise I", "Bwaise II", "Kazo", "Kikoni", "Kyebando", "Makerere I", "Makerere II", "Mulago I", "Mulago II", "Nsambya", "Kibuye I", "Kibuye II", "Makindye I", "Makindye II", "Salaama", "Banda", "Kiwatule", "Luzira", "Mbuya", "Mutungo", "Naguru", "Ntinda", "Lubya", "Lungujja", "Mutundwe", "Nateete", "Rubaga" ],
        "Gulu": [ "View All Subcounties/Parishes", "Gulu City West Division", "Gulu City East Division", "Awach Subcounty", "Paicho Subcounty", "Patiko Subcounty", "Unyama Subcounty", "Bardege-Layibi Division", "Pece-Laroo Division", "Awach Town Council", "Odek", "Ongako", "Palenga", "Palaro", "Pabwor", "Pageya", "Koch Goma", "Laliya", "Pawel" ],
        "Wakiso": [ "View All Subcounties/Towns", "Entebbe Municipality", "Kira Municipality", "Makindye Ssabagabo Municipality", "Nansana Municipality", "Wakiso Town Council", "Busukuma Subcounty", "Gombe Subcounty", "Kakiri Subcounty", "Kasanje Subcounty", "Katabi Subcounty", "Kyengera Town Council", "Masuliita Subcounty", "Mende Subcounty", "Nabweru Subcounty", "Namayumba Subcounty", "Nangabo Subcounty", "Ssisa Subcounty", "Nsangi Subcounty", "Vvumba Subcounty" ],
    };
    function prepareLocationList(locations) { if (!locations || locations.length === 0) return []; const viewAllText = locations.find(loc => loc.toLowerCase().includes("view all")) || "View All Specific Areas"; const specificLocs = locations.filter(loc => loc !== viewAllText); specificLocs.sort((a, b) => a.localeCompare(b)); return [viewAllText, ...specificLocs]; }
    for (const district in districtSpecificLocations) { districtSpecificLocations[district] = prepareLocationList(districtSpecificLocations[district]); }


    // --- DOM Elements ---
    const appContainer = document.getElementById('app-container');
    const appContent = document.querySelector('.app-content');
    const bottomNav = document.getElementById('bottom-nav');

    // Screens
    const authScreen = document.getElementById('auth-screen');
    const ownerDashboardScreen = document.getElementById('owner-dashboard-screen');
    const customerHomeScreen = document.getElementById('customer-home-screen');
    const chatListScreen = document.getElementById('chat-list-screen');
    const profileScreen = document.getElementById('profile-screen');
    const adminPanelScreen = document.getElementById('admin-panel-screen');
    const advertsScreen = document.getElementById('adverts-screen');
    const policeAlertsScreen = document.getElementById('police-alerts-screen'); // NEW Police Screen

    // Auth Forms
    const loginFormEl = document.getElementById('login-form');
    const registerFormEl = document.getElementById('register-form');
    const customerLoginFormEl = document.getElementById('customer-login-form');
    const customerRegisterFormEl = document.getElementById('customer-register-form');
    const adminLoginFormEl = document.getElementById('admin-login-form');
    const policeLoginFormEl = document.getElementById('police-login-form'); // NEW Police Form

    // Header/Status
    const userStatusDiv = document.getElementById('user-status');
    const ownerDetails = document.getElementById('owner-details');

    // Core Elements
    const ownerProductTableBody = document.getElementById('ownerProductTable').getElementsByTagName('tbody')[0];
    const ownerOrdersTableBody = document.getElementById('ownerOrdersTable').getElementsByTagName('tbody')[0];
    const ownerOrdersStatusDiv = document.getElementById('owner-orders-status');
    const ownerProductsStatusDiv = document.getElementById('owner-products-status');
    const productForm = document.getElementById('productForm');
    const districtSelectReg = document.getElementById('district');
    const businessSectorReg = document.getElementById('businessSectorReg');
    const districtFilter = document.getElementById('district-filter');
    const sectorFilter = document.getElementById('sector-filter');
    const productSearchInput = document.getElementById('product-search-input');
    const customerProductList = document.getElementById('customer-product-list');
    const customerProductStatus = document.getElementById('customer-product-status');
    const loginErrorDiv = document.getElementById('login-error');
    const registerErrorDiv = document.getElementById('register-error');
    const customerLoginErrorDiv = document.getElementById('customer-login-error');
    const customerRegisterErrorDiv = document.getElementById('customer-register-error');
    const adminLoginErrorDiv = document.getElementById('admin-login-error');
    const policeLoginErrorDiv = document.getElementById('police-login-error'); // NEW
    const orderForm = document.getElementById('orderForm');
    const ordersTableBody = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];
    const customerOrdersStatusDiv = document.getElementById('customer-orders-status');
    const currentOrderSection = document.getElementById('currentOrderSection');
    const currentOrderTableBody = document.getElementById('currentOrderTable').getElementsByTagName('tbody')[0];
    const orderTotalCostSpan = document.getElementById('orderTotalCost');
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackCustomerNameInput = document.getElementById('feedbackCustomerName');
    const specificLocationContainerReg = document.getElementById('specific-location-container-reg');
    const specificLocationSelectReg = document.getElementById('specific-location-reg');
    const specificLocationContainerFilter = document.getElementById('specific-location-container-filter');
    const specificLocationSelectFilter = document.getElementById('specific-location-filter');
    const chatModal = document.getElementById('chat-modal');
    const chatModalTitle = document.getElementById('chat-modal-title');
    const chatMessagesDiv = document.getElementById('chat-messages');
    const chatMessageInput = document.getElementById('chat-message-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const ownerChatListUl = document.getElementById('owner-chat-list');
    const ownerChatStatusP = document.getElementById('owner-chat-status');
    const ownerChatsSection = document.getElementById('owner-chats-section');
    const customerChatListUl = document.getElementById('customer-chat-list');
    const customerChatStatusP = document.getElementById('customer-chat-status');
    const customerChatsSection = document.getElementById('customer-chats-section');
    const ownerChangePasswordForm = document.getElementById('ownerChangePasswordForm');
    const ownerChangePwdErrorDiv = document.getElementById('owner-change-pwd-error');
    const ownerChangePwdSuccessDiv = document.getElementById('owner-change-pwd-success');
    const customerChangePasswordForm = document.getElementById('customerChangePasswordForm');
    const customerChangePwdErrorDiv = document.getElementById('customer-change-pwd-error');
    const customerChangePwdSuccessDiv = document.getElementById('customer-change-pwd-success');
    const adminBusinessOwnersTableBody = document.getElementById('adminBusinessOwnersTable').getElementsByTagName('tbody')[0];
    const adminCustomersTableBody = document.getElementById('adminCustomersTable').getElementsByTagName('tbody')[0];
    const adminFeedbackTableBody = document.getElementById('adminFeedbackTable').getElementsByTagName('tbody')[0];
    const adminOwnersStatusDiv = document.getElementById('admin-owners-status');
    const adminCustomersStatusDiv = document.getElementById('admin-customers-status');
    const adminFeedbackStatusDiv = document.getElementById('admin-feedback-status');
    const feedbackReplyModal = document.getElementById('feedback-reply-modal');
    const feedbackReplyForm = document.getElementById('feedbackReplyForm');
    const feedbackReplyIdInput = document.getElementById('feedbackReplyId');
    const feedbackReplyOriginalMessageDiv = document.getElementById('feedback-reply-original-message');
    const feedbackReplyExistingRepliesDiv = document.getElementById('feedback-reply-existing-replies');
    const feedbackReplyTextarea = document.getElementById('feedbackReplyText');
    const ownerFeedbackLogTableBody = document.getElementById('ownerFeedbackLogTable').getElementsByTagName('tbody')[0];
    const customerFeedbackLogTableBody = document.getElementById('customerFeedbackLogTable').getElementsByTagName('tbody')[0];
    const ownerFeedbackLogSection = document.getElementById('owner-feedback-log-section');
    const customerFeedbackLogSection = document.getElementById('customer-feedback-log-section');
    const ownerFeedbackStatusDiv = document.getElementById('owner-feedback-status');
    const customerFeedbackStatusDiv = document.getElementById('customer-feedback-status');
    const ownerChangePasswordWrapper = document.getElementById('owner-change-password-section-wrapper');
    const customerChangePasswordWrapper = document.getElementById('customer-change-password-section-wrapper');
    const customerFeedbackSubmitSection = document.getElementById('customer-feedback-submit-section');
    const customerPastOrdersSection = document.getElementById('customer-past-orders-section');
    const profileScreenTitle = document.getElementById('profile-screen-title');

    // Ratings Modal Elements
    const ratingsModal = document.getElementById('ratings-modal');
    const ratingsModalTitle = document.getElementById('ratings-modal-title');
    const ratingsProductName = document.getElementById('ratings-product-name');
    const ratingsAverageDiv = document.getElementById('ratings-average');
    const ratingsAverageStarsSpan = ratingsAverageDiv.querySelector('.stars');
    const ratingsCountSpan = document.getElementById('ratings-count');
    const ratingsListDiv = document.getElementById('ratings-list');
    const addRatingForm = document.getElementById('add-rating-form');
    const ratingTargetIdInput = document.getElementById('rating-target-id');
    const ratingTargetTypeInput = document.getElementById('rating-target-type');
    const ratingValueStarsDiv = document.getElementById('rating-value-stars');
    const ratingValueInput = document.getElementById('rating-value');
    const ratingCommentTextarea = document.getElementById('rating-comment');
    const addRatingErrorDiv = document.getElementById('add-rating-error');

    // Admin Password Change Elements
    const adminChangePasswordForm = document.getElementById('adminChangePasswordForm');
    const adminChangePwdErrorDiv = document.getElementById('admin-change-pwd-error');
    const adminChangePwdSuccessDiv = document.getElementById('admin-change-pwd-success');

    // Admin Police Account Creation Elements (NEW)
    const createPoliceAccountForm = document.getElementById('createPoliceAccountForm');
    const createPoliceMsgDiv = document.getElementById('create-police-msg');
    const adminPoliceAccountsTableBody = document.getElementById('adminPoliceAccountsTable').getElementsByTagName('tbody')[0];
    const adminPoliceStatusDiv = document.getElementById('admin-police-status');

    // Admin & Police Alert Display Elements (NEW)
    const adminAlertsTableBody = document.getElementById('adminAlertsTable').getElementsByTagName('tbody')[0];
    const adminAlertsStatusDiv = document.getElementById('admin-alerts-status');
    const policeAlertsTableBody = document.getElementById('policeAlertsTable').getElementsByTagName('tbody')[0];
    const policeAlertsStatusDiv = document.getElementById('police-alerts-status');

    // Advert Elements
    const ownerAdvertForm = document.getElementById('ownerAdvertForm');
    const ownerAdvertMsgDiv = document.getElementById('owner-advert-msg');
    const adminAdvertForm = document.getElementById('adminAdvertForm');
    const adminAdvertMsgDiv = document.getElementById('admin-advert-msg');
    const advertsListDiv = document.getElementById('adverts-list');
    const advertsStatusDiv = document.getElementById('adverts-status');
    const navAdvertsBtn = document.getElementById('nav-adverts');

    // Alert System Elements (NEW)
    const alertButton = document.getElementById('alert-button');
    const alertModal = document.getElementById('alert-modal');
    const alertForm = document.getElementById('alertForm');
    const alertReasonTextarea = document.getElementById('alert-reason');
    const alertLocationDisplay = document.getElementById('alert-location-display');
    const alertLocationCoordsInput = document.getElementById('alert-location-coords');
    const alertMediaDataInput = document.getElementById('alert-media-data');
    const alertMediaPreviewDiv = document.getElementById('alert-media-preview');
    const alertSendErrorDiv = document.getElementById('alert-send-error');


    // --- Global State ---
    let displayedProducts = [];
    let currentOrderItems = [];
    let currentOpenChat = { conversationId: null, targetName: null, targetUserId: null, currentUserRole: null };
    let loggedInCustomerInfo = null;
    let loggedInBusinessInfo = null;
    let loggedInPoliceInfo = null; // NEW
    let isAdminLoggedIn = false;
    let currentScreen = 'auth'; // Track the active screen ('auth', 'home', 'chats', 'adverts', 'profile', 'admin', 'police-alerts')
    let selectedRating = 0; // For the rating input stars


    // --- Utility Functions ---
    function getFromLocalStorage(key, defaultValue = []) {
        const data = localStorage.getItem(key);
        try { return data ? JSON.parse(data) : defaultValue; }
        catch (e) { console.error(`Error parsing localStorage key "${key}":`, e); return defaultValue; }
    }
    function saveToLocalStorage(key, data) {
         try { localStorage.setItem(key, JSON.stringify(data)); }
         catch (e) { console.error(`Error saving to localStorage key "${key}":`, e); alert("Error: Could not save data. Local storage might be full."); }
    }
    function populateSelectWithOptions(selectElementId, optionsArray, defaultOptionText, useDefaultValue = false) {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) return;
        selectElement.innerHTML = useDefaultValue ? `<option value="">${defaultOptionText}</option>` : `<option value="" disabled selected>${defaultOptionText}</option>`;
        optionsArray.forEach(optionText => {
            const option = document.createElement('option');
            option.value = optionText; option.textContent = optionText; selectElement.appendChild(option);
        });
    }
     function escapeHtml(unsafe) {
         if (typeof unsafe !== 'string') {
            if (unsafe === null || typeof unsafe === 'undefined') return "";
            try { unsafe = String(unsafe); } catch (e) { return ""; }
         }
         return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
     }
    function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        if (passwordInput) {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
        }
    }
    function populateSpecificLocationDropdown(selectElement, locations, defaultText = "-- Select Specific Area --") {
        selectElement.innerHTML = ''; // Clear existing options
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        const actualDefaultText = locations.find(loc => loc.toLowerCase().includes("view all")) || defaultText;
        defaultOption.textContent = escapeHtml(actualDefaultText);
        if (selectElement.id === 'specific-location-reg') {
             defaultOption.disabled = true; defaultOption.selected = true;
             defaultOption.textContent = "-- Select Specific Area --";
        } else { // Filter
             defaultOption.selected = true;
             defaultOption.textContent = "-- All Areas in District --";
        }
        selectElement.appendChild(defaultOption);
        locations.forEach(loc => {
            if (loc !== actualDefaultText) {
                 const option = document.createElement('option');
                 option.value = loc;
                 option.textContent = escapeHtml(loc);
                 selectElement.appendChild(option);
             }
        });
    }
    function toggleSectionVisibility(headerElement, contentId) {
        const contentElement = document.getElementById(contentId);
        if (contentElement) {
            const isVisible = contentElement.classList.toggle('is-visible');
            headerElement.classList.toggle('is-open', isVisible);
        }
    }
    function setActiveScreen(screenId) {
        document.querySelectorAll('.app-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
            appContent.scrollTop = 0;
        } else {
            console.error("Target screen not found:", screenId);
            authScreen.classList.add('active'); // Fallback
        }
        updateBottomNavActiveState(currentScreen);
    }
    function updateBottomNavActiveState(activeScreenName) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        // Adjust for police potentially having different nav item ID
        let activeNavItemId = `nav-${activeScreenName}`;
        if (activeScreenName === 'police-alerts') activeNavItemId = 'nav-police-alerts'; // Make sure ID matches

        const activeNavItem = document.getElementById(activeNavItemId);
        if (activeNavItem) {
            activeNavItem.classList.add('active');
        }
    }
    function navigateTo(screenName) {
         console.log("Navigating to:", screenName);
         currentScreen = screenName;

         let targetScreenId;
         switch (screenName) {
             case 'home':
                 targetScreenId = loggedInBusinessInfo ? 'owner-dashboard-screen' : 'customer-home-screen';
                 break;
             case 'chats':
                 targetScreenId = 'chat-list-screen';
                 if (loggedInBusinessInfo) displayOwnerConversations(loggedInBusinessInfo.id);
                 if (loggedInCustomerInfo) displayCustomerConversations(loggedInCustomerInfo.id);
                 // Police currently don't use chat list
                 break;
             case 'adverts':
                 targetScreenId = 'adverts-screen';
                 displayAdverts();
                 break;
             case 'profile':
                 targetScreenId = 'profile-screen';
                 prepareProfileScreen();
                 break;
             case 'admin':
                 if (isAdminLoggedIn) targetScreenId = 'admin-panel-screen';
                 else { console.warn("Admin nav clicked but not logged in."); handleLogout('admin'); return; }
                 break;
             case 'police-alerts': // NEW
                 if (loggedInPoliceInfo) targetScreenId = 'police-alerts-screen';
                 else { console.warn("Police alerts nav clicked but not logged in."); handleLogout('police'); return; }
                 displayPoliceAlerts(loggedInPoliceInfo.policeId); // Display alerts for the logged-in officer
                 break;
             case 'auth':
             default:
                 targetScreenId = 'auth-screen';
                 currentScreen = 'auth';
                 break;
         }
         setActiveScreen(targetScreenId);
    }
     function renderStars(rating, starContainerElement) {
         if (!starContainerElement) return;
         starContainerElement.innerHTML = '';
         const roundedRating = Math.round(rating * 2) / 2;
         for (let i = 1; i <= 5; i++) {
             const icon = document.createElement('i');
             icon.classList.add('material-icons');
             if (i <= roundedRating) { icon.textContent = 'star'; }
             else if (i - 0.5 === roundedRating) { icon.textContent = 'star_half'; }
             else { icon.textContent = 'star_border'; }
             starContainerElement.appendChild(icon);
         }
     }
     // Function to read file as Data URL (used for images) - Verified Existence
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        setupEventListeners();
        populateSelectWithOptions('district', ugandanDistricts, '-- Select District --');
        populateSelectWithOptions('businessSectorReg', businessSectors, '-- Select Sector --');
        populateSelectWithOptions('district-filter', ugandanDistricts, '-- All Districts --', true);
        populateSelectWithOptions('sector-filter', businessSectors, '-- All Sectors --', true);
        checkAdminLoginStatus();
        updateUI();
        setupDelegatedEventListeners();
        setupDistrictChangeHandlers();
        setupChatTextareaAutosize();
        setupRatingStarInput();

        // Trigger initial check for specific location visibility
        handleSpecificLocationVisibility(districtSelectReg, specificLocationContainerReg, specificLocationSelectReg);
        handleSpecificLocationVisibility(districtFilter, specificLocationContainerFilter, specificLocationSelectFilter);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered!', reg)).catch(err => console.log('SW registration failed:', err));
        }
    }

     function setupEventListeners() {
        // Auth Forms
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('customerLoginForm').addEventListener('submit', handleCustomerLogin);
        document.getElementById('customerRegisterForm').addEventListener('submit', handleCustomerRegister);
        document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
        document.getElementById('policeLoginForm').addEventListener('submit', handlePoliceLogin); // NEW

        // Core Forms
        productForm.addEventListener('submit', handleAddProduct);
        orderForm.addEventListener('submit', handleOrderSubmit);
        feedbackForm.addEventListener('submit', handleFeedbackSubmit);
        feedbackReplyForm.addEventListener('submit', handleFeedbackReplySubmit);
        addRatingForm.addEventListener('submit', handleAddRatingSubmit);
        ownerAdvertForm.addEventListener('submit', handleOwnerUploadAdvert);
        adminAdvertForm.addEventListener('submit', handleAdminUploadAdvert);
        createPoliceAccountForm.addEventListener('submit', handleCreatePoliceAccount); // NEW
        alertForm.addEventListener('submit', handleSendAlert); // NEW

        // Change Password Forms
        ownerChangePasswordForm.addEventListener('submit', handleChangeOwnerPassword);
        customerChangePasswordForm.addEventListener('submit', handleChangeCustomerPassword);
        adminChangePasswordForm.addEventListener('submit', handleChangeAdminPassword);

        // Chat
        chatMessageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
        });

        // Search Input Listener
        let searchTimeout;
        productSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { loadFilteredProducts(); }, 500);
        });
    }
    function setupChatTextareaAutosize() {
        chatMessageInput.addEventListener('input', () => {
            chatMessageInput.style.height = 'auto';
            chatMessageInput.style.height = (chatMessageInput.scrollHeight) + 'px';
        }, false);
    }
    function setupRatingStarInput() {
        ratingValueStarsDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('material-icons') && event.target.dataset.value) {
                selectedRating = parseInt(event.target.dataset.value, 10);
                ratingValueInput.value = selectedRating;
                updateStarSelectionUI();
            }
        });
    }
    function updateStarSelectionUI() {
        const stars = ratingValueStarsDiv.querySelectorAll('.material-icons');
        stars.forEach(star => {
            const starValue = parseInt(star.dataset.value, 10);
            if (starValue <= selectedRating) { star.textContent = 'star'; star.classList.add('selected'); }
            else { star.textContent = 'star_border'; star.classList.remove('selected'); }
        });
    }


    // --- Event Delegation & Specific Actions ---
    function setupDelegatedEventListeners() {
        // Owner: Delete product
        ownerProductTableBody.addEventListener('click', function(event) {
             if (event.target?.classList.contains('danger') && event.target.dataset.action === 'delete-product') {
                const productId = event.target.closest('tr')?.dataset.productId;
                if (productId) deleteProduct(productId);
             }
        });

        // Customer: Add item to order / Initiate Chat / View Ratings
        customerProductList.addEventListener('click', function(event) {
            const target = event.target;
            const card = target.closest('.product-card');
            if (!card ) return;
            const productId = card.dataset.productId;
            const businessUserId = card.dataset.businessUserId;
            const businessName = card.dataset.businessName;
            if (target.classList.contains('add-to-order-btn')) {
                 if (!loggedInCustomerInfo) { alert("Please log in to add items."); return; }
                const quantityInput = card.querySelector('.order-quantity-input');
                const quantity = parseInt(quantityInput?.value || '1', 10);
                handleAddToOrder(productId, quantity);
            } else if (target.classList.contains('chat-with-seller-btn')) {
                 if (!loggedInCustomerInfo) { alert("Please log in to chat."); return; }
                 if (businessUserId && businessName) { initiateChatWithSeller(businessUserId, businessName); }
                 else { console.error("Missing businessUserId or businessName"); alert("Cannot initiate chat."); }
            } else if (target.classList.contains('view-ratings-btn')) {
                if (productId) { openRatingsModal('product', productId); }
            }
        });

        // Customer: Modify/Remove item in current order
        currentOrderTableBody.addEventListener('input', function(event) {
             if (event.target?.classList.contains('cart-quantity-input')) {
                 const productId = event.target.dataset.productId;
                 const newQuantity = parseInt(event.target.value, 10);
                 updateCartItemQuantity(productId, newQuantity);
             }
        });
        currentOrderTableBody.addEventListener('click', function(event) {
            if (event.target?.classList.contains('remove-from-cart-btn')) {
                const productId = event.target.dataset.productId;
                removeFromCart(productId);
            }
        });

        // Chat List Click (Owner & Customer)
        chatListScreen.addEventListener('click', function(event){
             const listItem = event.target.closest('li');
             if(listItem?.dataset.conversationId) {
                 // Police don't use chat list currently
                 const userRole = loggedInBusinessInfo ? 'owner' : (loggedInCustomerInfo ? 'customer' : null);
                 if (!userRole) return;

                 const targetName = userRole === 'owner'
                     ? `Chat with ${listItem.dataset.customerContact || "Customer"}`
                     : `Chat with ${listItem.dataset.businessName || "Business"}`;
                 openChatModal(userRole, listItem.dataset.conversationId, targetName);
             }
        });

        // Chat Message Delete Click
        chatMessagesDiv.addEventListener('click', function(event) {
            const deleteButton = event.target.closest('.delete-msg-btn');
            if (deleteButton) {
                const messageDiv = deleteButton.closest('.chat-message');
                const messageId = messageDiv?.dataset.messageId;
                if (messageId && currentOpenChat.conversationId) { handleDeleteMessage(currentOpenChat.conversationId, messageId); }
            }
        });

        // Admin: Ban/Unban/Reply/Close/ResetPwd/DeletePolice Actions
        adminPanelScreen.addEventListener('click', handleAdminActionEvent);
    }
    function handleAdminActionEvent(event) {
        const button = event.target.closest('button');
        if (!button) return;

        const userId = button.dataset.userId; // For Business/Customer/Police
        const policeId = button.dataset.policeId; // Specific for Police account ID
        const feedbackId = button.dataset.feedbackId;
        const parentTable = button.closest('table');
        if (!parentTable) return;

        let userType = 'unknown';
        const isUserAction = button.classList.contains('ban-btn') || button.classList.contains('unban-btn') || button.classList.contains('reset-pwd-btn');

        if (isUserAction) {
            if (parentTable.id === 'adminBusinessOwnersTable') { userType = 'business'; }
            else if (parentTable.id === 'adminCustomersTable') { userType = 'customer'; }
            // Add check for police table if ban/reset actions are added there
        }

        if (button.classList.contains('ban-btn') || button.classList.contains('unban-btn')) {
            const shouldBan = button.classList.contains('ban-btn');
            if (userId && userType !== 'unknown') handleBanUser(userId, userType, shouldBan);
        } else if (button.classList.contains('reply-feedback-btn')) {
            if (feedbackId) openFeedbackReplyModal(feedbackId);
        } else if (button.classList.contains('close-feedback-btn')) {
            if (feedbackId) handleCloseFeedback(feedbackId);
        } else if (button.classList.contains('reset-pwd-btn')) {
             if (userId && userType !== 'unknown') handleAdminPasswordReset(userId, userType);
             // Add case for resetting Police password if needed, using policeId
        } else if (button.classList.contains('delete-police-btn')) { // NEW
             if (policeId) handleDeletePoliceAccount(policeId);
        }
    }

    // --- District Change Handlers ---
     function setupDistrictChangeHandlers() {
        districtSelectReg.addEventListener('change', () => handleSpecificLocationVisibility(districtSelectReg, specificLocationContainerReg, specificLocationSelectReg));
        districtFilter.addEventListener('change', () => handleSpecificLocationVisibility(districtFilter, specificLocationContainerFilter, specificLocationSelectFilter));
    }
    function handleSpecificLocationVisibility(districtSelect, container, specificLocationSelect) {
        const selectedDistrict = districtSelect.value;
        const locations = districtSpecificLocations[selectedDistrict];
        if (locations && locations.length > 1) {
            container.style.display = 'block';
            populateSpecificLocationDropdown(specificLocationSelect, locations);
            if (specificLocationSelect.id === 'specific-location-reg') { specificLocationSelect.required = true; }
        } else {
            container.style.display = 'none';
            specificLocationSelect.innerHTML = '<option value="">-- Select Specific Area --</option>';
            specificLocationSelect.value = "";
            if (specificLocationSelect.id === 'specific-location-reg') { specificLocationSelect.required = false; }
        }
    }


    // --- UI State Management ---
     function updateUI() {
        const currentBusinessUserEmail = getFromLocalStorage(CURRENT_USER_KEY, null);
        const currentCustomerId = getFromLocalStorage(CURRENT_CUSTOMER_KEY, null);
        const currentPoliceUserId = getFromLocalStorage(CURRENT_POLICE_USER_KEY, null); // NEW
        isAdminLoggedIn = !!getFromLocalStorage('wano_admin_logged_in', false);

        // Reset global state
        loggedInCustomerInfo = null; loggedInBusinessInfo = null; loggedInPoliceInfo = null;

        // Clear header & status messages
        userStatusDiv.innerHTML = '';
        loginErrorDiv.textContent = ''; registerErrorDiv.textContent = '';
        customerLoginErrorDiv.textContent = ''; customerRegisterErrorDiv.textContent = '';
        adminLoginErrorDiv.textContent = ''; policeLoginErrorDiv.textContent = ''; // NEW
        ownerChangePwdErrorDiv.textContent = ''; ownerChangePwdSuccessDiv.textContent = '';
        customerChangePwdErrorDiv.textContent = ''; customerChangePwdSuccessDiv.textContent = '';
        adminChangePwdErrorDiv.textContent = ''; adminChangePwdSuccessDiv.textContent = '';
        ownerAdvertMsgDiv.textContent = ''; ownerAdvertMsgDiv.className = 'success-message';
        adminAdvertMsgDiv.textContent = ''; adminAdvertMsgDiv.className = 'success-message';
        createPoliceMsgDiv.textContent = ''; createPoliceMsgDiv.className = 'success-message'; // NEW
        addRatingErrorDiv.textContent = '';
        alertSendErrorDiv.textContent = ''; // Clear alert error

        // Hide collapsible sections
        document.querySelectorAll('.toggleable-section .form-content').forEach(el => el.classList.remove('is-visible'));
        document.querySelectorAll('.toggleable-section .toggle-header').forEach(el => el.classList.remove('is-open'));

        // Hide all nav items initially, then show relevant ones
        document.querySelectorAll('.nav-item').forEach(item => item.style.display = 'none');
        bottomNav.style.display = 'none'; // Hide nav bar by default
        alertButton.style.display = 'block'; // Show alert button by default (could hide if not logged in)

        let targetScreenName = 'auth';

        if (isAdminLoggedIn) {
            userStatusDiv.innerHTML = `<span>Admin Mode</span> <button onclick="handleLogout('admin')" class="danger small header-button">Logout</button>`;
            bottomNav.style.display = 'flex';
            document.getElementById('nav-admin').style.display = 'flex';
            document.getElementById('nav-adverts').style.display = 'flex'; // Admin can see/post adverts
            targetScreenName = currentScreen === 'auth' ? 'admin' : currentScreen;
            displayAdminBusinessOwners(); displayAdminCustomers(); displayAdminFeedback();
            displayAdminPoliceAccounts(); // NEW
            displayAdminAlerts(); // NEW
            adminChangePasswordForm.reset();
            document.getElementById('admin-change-password-content').classList.remove('is-visible');
            document.querySelector('#admin-change-password-section-wrapper .toggle-header').classList.remove('is-open');

        } else if (currentPoliceUserId) { // NEW Police check
            const policeAccounts = getFromLocalStorage(POLICE_ACCOUNTS_KEY);
            const currentPolice = policeAccounts.find(p => p.policeId === currentPoliceUserId);
            if (currentPolice) { // Add banned check if implemented for police
                loggedInPoliceInfo = currentPolice;
                userStatusDiv.innerHTML = `<span>Officer: ${escapeHtml(currentPolice.name)} (${escapeHtml(currentPolice.policeId)})</span> <button onclick="handleLogout('police')" class="danger small header-button">Logout</button>`;
                ownerDetails.style.display = 'none';
                bottomNav.style.display = 'flex';
                document.getElementById('nav-police-alerts').style.display = 'flex'; // Show police alerts nav
                document.getElementById('nav-adverts').style.display = 'flex'; // Police can see adverts
                targetScreenName = currentScreen === 'auth' ? 'police-alerts' : currentScreen;
                displayPoliceAlerts(currentPolice.policeId);

            } else { handleLogout('police'); return; }

        } else if (currentBusinessUserEmail) {
            const users = getFromLocalStorage(USERS_KEY);
            const currentUser = users.find(u => u.email === currentBusinessUserEmail);
            if (currentUser && !currentUser.banned) {
                loggedInBusinessInfo = currentUser;
                userStatusDiv.innerHTML = `<span>Owner: ${escapeHtml(currentUser.businessName)}</span> <button onclick="handleLogout('owner')" class="danger small header-button">Logout</button>`;
                ownerDetails.textContent = `Sector: ${escapeHtml(currentUser.businessSector)} | District: ${escapeHtml(currentUser.district)}${currentUser.specificLocation ? ` | Area: ${escapeHtml(currentUser.specificLocation)}` : ''}`;
                ownerDetails.style.display = 'block';
                bottomNav.style.display = 'flex';
                document.getElementById('nav-home').style.display = 'flex';
                document.getElementById('nav-chats').style.display = 'flex';
                document.getElementById('nav-adverts').style.display = 'flex';
                document.getElementById('nav-profile').style.display = 'flex';
                targetScreenName = currentScreen === 'auth' ? 'home' : currentScreen;
                displayOwnerProducts(currentUser.id);
                displayOwnerReceivedOrders(currentUser.id);
                displayOwnerConversations(currentUser.id);
                displayOwnerFeedbackLog(currentUser.id);
                ownerFeedbackLogSection.style.display = 'block';
                ownerChangePasswordWrapper.style.display = 'block';
                ownerChangePasswordForm.reset();
                document.getElementById('owner-change-password-content').classList.remove('is-visible');
                document.querySelector('#owner-change-password-section-wrapper .toggle-header').classList.remove('is-open');
            } else {
                if (currentUser?.banned) alert("Your business account has been suspended.");
                handleLogout('owner'); return;
            }
        } else if (currentCustomerId) {
            const customers = getFromLocalStorage(CUSTOMER_ACCOUNTS_KEY);
            const currentCustomer = customers.find(c => c.id === currentCustomerId);
            if (currentCustomer && !currentCustomer.banned) {
                loggedInCustomerInfo = currentCustomer;
                userStatusDiv.innerHTML = `<span>Hi, ${escapeHtml(currentCustomer.name)}</span> <button onclick="handleLogout('customer')" class="danger small header-button">Logout</button>`;
                ownerDetails.style.display = 'none';
                bottomNav.style.display = 'flex';
                document.getElementById('nav-home').style.display = 'flex';
                document.getElementById('nav-chats').style.display = 'flex';
                document.getElementById('nav-adverts').style.display = 'flex';
                document.getElementById('nav-profile').style.display = 'flex';
                targetScreenName = currentScreen === 'auth' ? 'home' : currentScreen;
                feedbackCustomerNameInput.value = currentCustomer.name;
                customerProductStatus.innerHTML = `<p id="customer-product-placeholder">Use filters above or search to find products.</p>`;
                customerProductStatus.style.display = 'block';
                customerProductList.innerHTML = '';
                handleSpecificLocationVisibility(districtFilter, specificLocationContainerFilter, specificLocationSelectFilter);
                displayCustomerConversations(currentCustomer.id);
                displayStoredOrders(currentCustomer.id);
                displayCustomerFeedbackLog(currentCustomer.id);
                 customerFeedbackLogSection.style.display = 'block';
                 customerChangePasswordWrapper.style.display = 'block';
                 customerFeedbackSubmitSection.style.display = 'block';
                 customerPastOrdersSection.style.display = 'block';
                currentOrderItems = []; displayCurrentOrder();
                 customerChangePasswordForm.reset();
                 document.getElementById('customer-change-password-content').classList.remove('is-visible');
                 document.querySelector('#customer-change-password-section-wrapper .toggle-header').classList.remove('is-open');
            } else {
                 if (currentCustomer?.banned) alert("Your customer account has been suspended.");
                 handleLogout('customer'); return;
            }
        } else {
            // No one logged in
            targetScreenName = 'auth';
            bottomNav.style.display = 'none';
            ownerDetails.style.display = 'none';
            // alertButton.style.display = 'none'; // Option: Hide alert button if not logged in
            userStatusDiv.innerHTML = `
                <button onclick="showCustomerLoginForm()" class="header-button secondary small">Customer</button>
                <button onclick="showLoginForm()" class="header-button secondary small">Business</button>
                <button onclick="showAdminLoginForm()" class="header-button info small">Admin</button>
                <button onclick="showPoliceLoginForm()" class="header-button warning small">Police</button> <!-- NEW -->
            `;
            showCustomerLoginForm(); // Default to customer login form
        }

        // Set active screen only if the target is different from current screen
        // or if forcing a refresh (e.g., after login/logout)
        if (currentScreen !== targetScreenName || targetScreenName === 'auth') {
            navigateTo(targetScreenName);
        } else {
            // If staying on the same screen, just ensure nav state is correct
             updateBottomNavActiveState(currentScreen);
        }
     }
    function prepareProfileScreen() {
        ownerFeedbackLogSection.style.display = 'none'; customerFeedbackLogSection.style.display = 'none';
        ownerChangePasswordWrapper.style.display = 'none'; customerChangePasswordWrapper.style.display = 'none';
        customerFeedbackSubmitSection.style.display = 'none'; customerPastOrdersSection.style.display = 'none';

        if (loggedInBusinessInfo) {
            profileScreenTitle.textContent = `${escapeHtml(loggedInBusinessInfo.businessName)} - Settings`;
            ownerFeedbackLogSection.style.display = 'block'; ownerChangePasswordWrapper.style.display = 'block';
            displayOwnerFeedbackLog(loggedInBusinessInfo.id);
        } else if (loggedInCustomerInfo) {
            profileScreenTitle.textContent = `${escapeHtml(loggedInCustomerInfo.name)} - Profile`;
            customerFeedbackSubmitSection.style.display = 'block'; customerFeedbackLogSection.style.display = 'block';
            customerChangePasswordWrapper.style.display = 'block'; customerPastOrdersSection.style.display = 'block';
            displayCustomerFeedbackLog(loggedInCustomerInfo.id); displayStoredOrders(loggedInCustomerInfo.id);
        } else {
            // Police don't have a profile screen currently
            profileScreenTitle.textContent = 'Profile & Settings';
        }
         document.querySelectorAll('#profile-screen .form-content').forEach(el => el.classList.remove('is-visible'));
         document.querySelectorAll('#profile-screen .toggle-header').forEach(el => el.classList.remove('is-open'));
    }


    // Auth Form Visibility Functions
     function showLoginForm() { /* Business */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'block'; registerFormEl.style.display = 'none'; customerLoginFormEl.style.display = 'none'; customerRegisterFormEl.style.display = 'none'; adminLoginFormEl.style.display = 'none'; policeLoginFormEl.style.display = 'none';
    }
    function showRegisterForm() { /* Business */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'none'; registerFormEl.style.display = 'block'; customerLoginFormEl.style.display = 'none'; customerRegisterFormEl.style.display = 'none'; adminLoginFormEl.style.display = 'none'; policeLoginFormEl.style.display = 'none';
    }
    function showCustomerLoginForm() { /* Customer */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'none'; registerFormEl.style.display = 'none'; customerLoginFormEl.style.display = 'block'; customerRegisterFormEl.style.display = 'none'; adminLoginFormEl.style.display = 'none'; policeLoginFormEl.style.display = 'none';
    }
    function showCustomerRegisterForm() { /* Customer */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'none'; registerFormEl.style.display = 'none'; customerLoginFormEl.style.display = 'none'; customerRegisterFormEl.style.display = 'block'; adminLoginFormEl.style.display = 'none'; policeLoginFormEl.style.display = 'none';
    }
    function showAdminLoginForm() { /* Admin */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'none'; registerFormEl.style.display = 'none'; customerLoginFormEl.style.display = 'none'; customerRegisterFormEl.style.display = 'none'; adminLoginFormEl.style.display = 'block'; policeLoginFormEl.style.display = 'none';
    }
    function showPoliceLoginForm() { /* Police - NEW */
        setActiveScreen('auth-screen');
        loginFormEl.style.display = 'none'; registerFormEl.style.display = 'none'; customerLoginFormEl.style.display = 'none'; customerRegisterFormEl.style.display = 'none'; adminLoginFormEl.style.display = 'none'; policeLoginFormEl.style.display = 'block';
    }


    // --- Authentication ---
    async function handleRegister(event) { // Added async for image reading
         event.preventDefault(); registerErrorDiv.textContent = ''; const users = getFromLocalStorage(USERS_KEY);
         const businessName = document.getElementById('businessName').value.trim();
         const email = document.getElementById('registerEmail').value.trim().toLowerCase();
         const password = document.getElementById('registerPassword').value;
         const phone = document.getElementById('phoneContact').value.trim();
         const nin = document.getElementById('ninNumber').value.trim();
         const sector = businessSectorReg.value;
         const district = districtSelectReg.value;
         const furtherLocationDetail = document.getElementById('location').value.trim();
         const ownerPhotoFile = document.getElementById('ownerPhoto').files[0];
         let specificLocation = null;
         if (specificLocationContainerReg.style.display === 'block') {
            specificLocation = specificLocationSelectReg.value;
            if (!specificLocation || specificLocation === specificLocationSelectReg.options[0].value) {
                 registerErrorDiv.textContent = 'Please select a specific Area for this district.'; return;
             }
         }
         if (!businessName || !email || !password || !phone || !nin || !sector || !district || !furtherLocationDetail || !ownerPhotoFile) { registerErrorDiv.textContent = 'All fields except Specific Area (if applicable) are required.'; return; }
         if (specificLocationContainerReg.style.display === 'block' && (!specificLocation || specificLocation === specificLocationSelectReg.options[0].value)) {
              registerErrorDiv.textContent = 'Please select a specific Area for this district.'; return;
         }
         if (password.length < 6) { registerErrorDiv.textContent = 'Password min 6 characters.'; return; }
         if (users.some(user => user.email === email)) { registerErrorDiv.textContent = 'Email already registered.'; return; }

         try {
             const photoDataUrl = await readFileAsDataURL(ownerPhotoFile);
             const newUser = {
                  id: `biz_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`,
                  businessName, email, password, phone, nin, ownerPhoto: photoDataUrl,
                  businessSector: sector, district,
                  specificLocation: specificLocation,
                  furtherLocationDetail: furtherLocationDetail,
                  registrationDate: new Date().toISOString(), banned: false
             };
              users.push(newUser); saveToLocalStorage(USERS_KEY, users);
              saveToLocalStorage(CURRENT_USER_KEY, newUser.email);
              document.getElementById('registerForm').reset();
              handleSpecificLocationVisibility(districtSelectReg, specificLocationContainerReg, specificLocationSelectReg);
              updateUI();
              alert('Business registration successful!');
         } catch (error) {
              console.error("Error reading owner photo:", error);
              registerErrorDiv.textContent = 'Error processing owner photo.';
         }
    }
    function handleLogin(event) { /* Business */
        event.preventDefault(); loginErrorDiv.textContent = '';
        const users = getFromLocalStorage(USERS_KEY);
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) { loginErrorDiv.textContent = 'Email and password required.'; return; }
        const user = users.find(u => u.email === email);
        if (user && user.password === password) {
            if (user.banned) { loginErrorDiv.textContent = 'This business account has been suspended.'; return; }
            saveToLocalStorage(CURRENT_USER_KEY, user.email);
            document.getElementById('loginForm').reset(); updateUI();
        } else { loginErrorDiv.textContent = 'Invalid business email or password.'; }
    }
    function handleCustomerRegister(event) { /* Customer */
        event.preventDefault(); customerRegisterErrorDiv.textContent = '';
        const customers = getFromLocalStorage(CUSTOMER_ACCOUNTS_KEY);
        const name = document.getElementById('customerRegisterName').value.trim();
        const email = document.getElementById('customerRegisterEmail').value.trim().toLowerCase();
        const phone = document.getElementById('customerRegisterPhone').value.trim();
        const password = document.getElementById('customerRegisterPassword').value;
        if (!name || !email || !phone || !password) { customerRegisterErrorDiv.textContent = 'All fields are required.'; return; }
        if (password.length < 6) { customerRegisterErrorDiv.textContent = 'Password min 6 characters.'; return; }
        if (!/\S+@\S+\.\S+/.test(email)) { customerRegisterErrorDiv.textContent = 'Invalid email format.'; return; }
        // Basic phone validation (adjust as needed)
        if (!/^\+?\d{10,15}$/.test(phone.replace(/\s+/g, ''))) { customerRegisterErrorDiv.textContent = 'Invalid phone number format.'; return; }
        if (customers.some(c => c.email === email)) { customerRegisterErrorDiv.textContent = 'Email address already registered.'; return; }
        if (customers.some(c => c.phone === phone)) { customerRegisterErrorDiv.textContent = 'Phone number already registered.'; return; }
        const newCustomer = {
            id: `cust_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`,
            name, email, phone, password, registrationDate: new Date().toISOString(), banned: false
        };
        customers.push(newCustomer); saveToLocalStorage(CUSTOMER_ACCOUNTS_KEY, customers);
        saveToLocalStorage(CURRENT_CUSTOMER_KEY, newCustomer.id);
        document.getElementById('customerRegisterForm').reset(); updateUI();
        alert('Customer registration successful!');
    }
    function handleCustomerLogin(event) { /* Customer */
        event.preventDefault(); customerLoginErrorDiv.textContent = '';
        const customers = getFromLocalStorage(CUSTOMER_ACCOUNTS_KEY);
        const identifier = document.getElementById('customerLoginIdentifier').value.trim();
        const password = document.getElementById('customerLoginPassword').value;
        if (!identifier || !password) { customerLoginErrorDiv.textContent = 'Identifier (Email/Phone) and password required.'; return; }
        const customer = customers.find(c => (c.email.toLowerCase() === identifier.toLowerCase() || c.phone === identifier) && c.password === password);
        if (customer) {
            if (customer.banned) { customerLoginErrorDiv.textContent = 'This customer account has been suspended.'; return; }
            saveToLocalStorage(CURRENT_CUSTOMER_KEY, customer.id);
            document.getElementById('customerLoginForm').reset(); updateUI();
        } else { customerLoginErrorDiv.textContent = 'Invalid email/phone or password.'; }
    }
    function handleAdminLogin(event) { /* Admin */
        event.preventDefault(); adminLoginErrorDiv.textContent = '';
        const email = document.getElementById('adminLoginEmail').value.trim();
        const password = document.getElementById('adminLoginPassword').value;
        // ** INSECURE ** Compare against the current ADMIN_PASSWORD variable
        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
            saveToLocalStorage('wano_admin_logged_in', true);
            isAdminLoggedIn = true; document.getElementById('adminLoginForm').reset(); updateUI();
        } else { adminLoginErrorDiv.textContent = 'Invalid admin credentials.'; }
    }
    function handlePoliceLogin(event) { /* Police - NEW */
        event.preventDefault(); policeLoginErrorDiv.textContent = '';
        const policeAccounts = getFromLocalStorage(POLICE_ACCOUNTS_KEY);
        const policeId = document.getElementById('policeLoginId').value.trim();
        const password = document.getElementById('policeLoginPassword').value;
        if (!policeId || !password) { policeLoginErrorDiv.textContent = 'Police ID and password required.'; return; }

        const policeUser = policeAccounts.find(p => p.policeId === policeId && p.password === password);

        if (policeUser) {
            // Add banned check here if you implement banning for police
            // if (policeUser.banned) { policeLoginErrorDiv.textContent = 'This account has been suspended.'; return; }
            saveToLocalStorage(CURRENT_POLICE_USER_KEY, policeUser.policeId);
            document.getElementById('policeLoginForm').reset(); updateUI();
        } else {
            policeLoginErrorDiv.textContent = 'Invalid Police ID or password.';
        }
    }

    function checkAdminLoginStatus() { isAdminLoggedIn = !!getFromLocalStorage('wano_admin_logged_in', false); }
    function handleLogout(userType) {
        console.log("Logging out:", userType);
        if (userType === 'owner') { localStorage.removeItem(CURRENT_USER_KEY); loggedInBusinessInfo = null; }
        else if (userType === 'customer') { localStorage.removeItem(CURRENT_CUSTOMER_KEY); loggedInCustomerInfo = null; currentOrderItems = []; }
        else if (userType === 'admin') { localStorage.removeItem('wano_admin_logged_in'); isAdminLoggedIn = false; }
        else if (userType === 'police') { localStorage.removeItem(CURRENT_POLICE_USER_KEY); loggedInPoliceInfo = null; } // NEW

        // Reset all potential logged-in states
        loggedInBusinessInfo = null; loggedInCustomerInfo = null; isAdminLoggedIn = false; loggedInPoliceInfo = null;
        currentOrderItems = []; displayedProducts = []; currentScreen = 'auth';
        updateUI();
    }


    // --- Product Management (Owner) ---
     async function handleAddProduct(event) {
        event.preventDefault();
        if (!loggedInBusinessInfo) { alert("Session expired."); handleLogout('owner'); return; }
        const name = document.getElementById('productName').value.trim();
        const description = document.getElementById('productDescription').value.trim();
        const price = document.getElementById('productPrice').value;
        const productImageFile = document.getElementById('productImage').files[0];
         if (!name || !description || !price || !productImageFile) { alert('Please fill all product details.'); return; }
         if (isNaN(price) || parseFloat(price) < 0) { alert('Invalid price.'); return; }

         try {
            const imageDataUrl = await readFileAsDataURL(productImageFile);
            const products = getFromLocalStorage(PRODUCTS_KEY);
            const newProduct = {
                 id: `prod_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`,
                 userId: loggedInBusinessInfo.id,
                 businessName: loggedInBusinessInfo.businessName,
                 ownerContact: loggedInBusinessInfo.phone, businessSector: loggedInBusinessInfo.businessSector,
                 district: loggedInBusinessInfo.district,
                 specificLocation: loggedInBusinessInfo.specificLocation || null,
                 furtherLocationDetail: loggedInBusinessInfo.furtherLocationDetail || null,
                 name, description, price: parseFloat(price), image: imageDataUrl,
                 ownerPhoto: loggedInBusinessInfo.ownerPhoto || DEFAULT_OWNER_PHOTO,
                 addedDate: new Date().toISOString()
             };
             products.push(newProduct); saveToLocalStorage(PRODUCTS_KEY, products);
             productForm.reset();
             displayOwnerProducts(loggedInBusinessInfo.id);
             alert('Product added successfully!');
         } catch (error) {
             console.error("Error reading product image:", error);
             alert('Error processing product image.');
         }
     }
    function displayOwnerProducts(ownerUserId) {
        const ownerProducts = getFromLocalStorage(PRODUCTS_KEY).filter(p => p.userId === ownerUserId);
        ownerProductTableBody.innerHTML = '';
        ownerProductsStatusDiv.textContent = '';
        if (ownerProducts.length === 0) {
            ownerProductsStatusDiv.textContent = 'No products added yet.';
            ownerProductTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Use the form above to add your first product.</td></tr>'; return;
        }
        ownerProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        ownerProducts.forEach((product) => {
            const row = ownerProductTableBody.insertRow(); row.dataset.productId = product.id;
            row.innerHTML = `
                <td><img src="${product.image || DEFAULT_OWNER_PHOTO}" alt="${escapeHtml(product.name)}" class="product-image"></td>
                <td>${escapeHtml(product.name)}<br><small>${escapeHtml(product.description.substring(0, 50))}${product.description.length > 50 ? '...' : ''}</small></td>
                <td class="price">UGX ${product.price.toLocaleString()}</td>
                <td><button class="danger small" data-action="delete-product" style="text-transform: none;">Delete</button></td>`;
        });
     }
    function deleteProduct(productId) {
         if (!confirm('Are you sure you want to delete this product?')) return;
         if (!loggedInBusinessInfo) { alert("Session expired."); handleLogout('owner'); return; }
         let products = getFromLocalStorage(PRODUCTS_KEY);
         const initialLength = products.length;
         products = products.filter(p => !(p.id === productId && p.userId === loggedInBusinessInfo.id));
         if (products.length < initialLength) {
             saveToLocalStorage(PRODUCTS_KEY, products);
             let ratings = getFromLocalStorage(RATINGS_COMMENTS_KEY);
             ratings = ratings.filter(r => !(r.targetType === 'product' && r.targetId === productId));
             saveToLocalStorage(RATINGS_COMMENTS_KEY, ratings);
             displayOwnerProducts(loggedInBusinessInfo.id);
             removeFromCart(productId, false); // Remove from customer cart if present
             alert('Product and associated ratings deleted.');
         } else { alert('Error: Product not found or permission denied.'); }
     }

    // --- Customer View: Product Loading & Filtering ---
    function loadFilteredProducts() {
        const selectedDistrict = districtFilter.value;
        const selectedSector = sectorFilter.value;
        const searchTerm = productSearchInput.value.trim().toLowerCase();
        const allProducts = getFromLocalStorage(PRODUCTS_KEY);
        let selectedSpecificLocation = null;
        if (specificLocationContainerFilter.style.display === 'block') {
            selectedSpecificLocation = specificLocationSelectFilter.value;
        }

        customerProductList.innerHTML = ''; customerProductStatus.style.display = 'block';
        displayedProducts = [];

        let statusMsg = "Loading..."; customerProductStatus.innerHTML = `<p>${statusMsg}</p>`;

        // Filter out products from banned owners first
        let filteredProducts = allProducts.filter(p => {
             const owner = getFromLocalStorage(USERS_KEY).find(u => u.id === p.userId);
             return owner && !owner.banned; // Ensure owner exists and is not banned
         });

        if (selectedDistrict) { filteredProducts = filteredProducts.filter(p => p.district === selectedDistrict); }
        if (selectedSpecificLocation && selectedSpecificLocation !== specificLocationSelectFilter.options[0].value) {
            filteredProducts = filteredProducts.filter(p => p.specificLocation === selectedSpecificLocation);
        }
        if (selectedSector) { filteredProducts = filteredProducts.filter(p => p.businessSector === selectedSector); }
        if (searchTerm) { filteredProducts = filteredProducts.filter(p => (p.name && p.name.toLowerCase().includes(searchTerm)) || (p.description && p.description.toLowerCase().includes(searchTerm)) || (p.businessName && p.businessName.toLowerCase().includes(searchTerm))); }

        filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        if (filteredProducts.length === 0) {
             let notFoundMsg = "No products found";
             if(selectedDistrict || selectedSector || searchTerm || (selectedSpecificLocation && selectedSpecificLocation !== specificLocationSelectFilter.options[0].value)) { notFoundMsg += " matching your criteria."; }
             else { notFoundMsg += ". Try different filters or search."; }
             customerProductStatus.innerHTML = `<p>${notFoundMsg}</p>`;
        } else {
            customerProductStatus.style.display = 'none';
            filteredProducts.forEach(product => {
                const card = document.createElement('div'); card.className = 'product-card';
                card.dataset.productId = product.id; card.dataset.businessUserId = product.userId; card.dataset.businessName = product.businessName;
                const locationDisplay = escapeHtml(product.district || '') + (product.specificLocation ? `, ${escapeHtml(product.specificLocation)}` : '') + (product.furtherLocationDetail ? ` (${escapeHtml(product.furtherLocationDetail)})` : '');
                const { average, count } = calculateAverageRating('product', product.id);
                const avgRatingHtml = `<span class="stars"></span> <span style="font-size: 0.8em; color: #666;">(${count})</span>`;
                const contentWrapper = document.createElement('div'); contentWrapper.className = 'product-card-content';
                const isLoggedInCustomer = !!loggedInCustomerInfo;
                const addBtnDisabled = isLoggedInCustomer ? '' : 'disabled'; const chatBtnDisabled = isLoggedInCustomer ? '' : 'disabled'; const ratingBtnDisabled = isLoggedInCustomer ? '' : 'disabled';
                contentWrapper.innerHTML = `
                    <h4>${escapeHtml(product.name)}</h4>
                    <p>${escapeHtml(product.description)}</p>
                    <p class="price">UGX ${product.price.toLocaleString()}</p>
                    <div class="product-rating"> ${avgRatingHtml} <button type="button" class="view-ratings-btn info small" ${ratingBtnDisabled} style="margin-left: auto;">Ratings & Comments</button> </div>
                    <div class="order-controls"> <label for="qty-${product.id}">Qty:</label> <input type="number" id="qty-${product.id}" class="order-quantity-input" value="1" min="1" ${addBtnDisabled}> <button type="button" class="add-to-order-btn secondary small" ${addBtnDisabled}>Add</button> <button type="button" class="chat-with-seller-btn info small" ${chatBtnDisabled}>Chat</button> </div>
                    <div class="business-info"> <img src="${product.ownerPhoto || DEFAULT_OWNER_PHOTO}" alt="Owner" class="owner-photo"> <div>Sold by: <strong>${escapeHtml(product.businessName)}</strong><br> <span style="font-size: 0.9em;"> ${locationDisplay}</span> </div> </div>`;
                card.innerHTML = `<img src="${product.image || DEFAULT_OWNER_PHOTO}" alt="${escapeHtml(product.name)}" class="product-image">`;
                card.appendChild(contentWrapper);
                customerProductList.appendChild(card);
                const starContainer = card.querySelector('.product-rating .stars');
                renderStars(average, starContainer);
            });
        }
    }


    // --- Cart / Order Management ---
    function handleAddToOrder(productId, quantity) {
        if (!loggedInCustomerInfo) { alert("Please log in."); return; }
        if (!quantity || quantity < 1) { alert("Invalid quantity."); return; }
        const productToAdd = getFromLocalStorage(PRODUCTS_KEY).find(p => p.id === productId);
        if (!productToAdd) { alert("Error: Product details not found."); return; }
        // Check if owner is banned before adding
        const owner = getFromLocalStorage(USERS_KEY).find(u => u.id === productToAdd.userId);
        if (!owner || owner.banned) { alert("This product cannot be ordered at the moment."); return; }

        const existingCartItemIndex = currentOrderItems.findIndex(item => item.id === productId);
        if (existingCartItemIndex > -1) { currentOrderItems[existingCartItemIndex].quantity += quantity; }
        else { currentOrderItems.push({ id: productToAdd.id, name: productToAdd.name, price: productToAdd.price, quantity: quantity, userId: productToAdd.userId }); }
        const input = document.getElementById(`qty-${productId}`); if (input) input.value = 1;
        displayCurrentOrder();
        // Simple visual feedback
        const feedback = document.createElement('div');
        feedback.textContent = `${quantity} x ${escapeHtml(productToAdd.name)} added/updated.`;
        feedback.style.cssText = "position:fixed; bottom:70px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:8px 15px; border-radius:15px; font-size:0.9em; z-index: 3000;";
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
    }
    function updateCartItemQuantity(productId, newQuantity) {
        if (!loggedInCustomerInfo) return;
        if (newQuantity < 1) { removeFromCart(productId); return; }
        const itemIndex = currentOrderItems.findIndex(item => item.id === productId);
        if (itemIndex > -1) { currentOrderItems[itemIndex].quantity = newQuantity; displayCurrentOrder(); }
    }
    function removeFromCart(productId, redisplay = true) {
         if (!loggedInCustomerInfo && redisplay) return; // Only customers have carts
         currentOrderItems = currentOrderItems.filter(item => item.id !== productId);
         if (redisplay) { displayCurrentOrder(); }
     }
    function displayCurrentOrder() {
        currentOrderTableBody.innerHTML = ''; let totalCost = 0;
        if (currentOrderItems.length === 0) { currentOrderSection.style.display = 'none'; orderTotalCostSpan.textContent = '0'; }
        else {
            currentOrderSection.style.display = 'block';
            currentOrderItems.forEach(item => {
                const row = currentOrderTableBody.insertRow(); const subtotal = item.price * item.quantity; totalCost += subtotal;
                row.innerHTML = `
                    <td>${escapeHtml(item.name)}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td><input type="number" class="cart-quantity-input" value="${item.quantity}" min="1" data-product-id="${item.id}" style="width: 50px; padding: 4px; text-align: center;"></td>
                    <td class="item-subtotal">${subtotal.toLocaleString()}</td>
                    <td><button class="danger small remove-from-cart-btn" data-product-id="${item.id}" style="padding: 4px 6px; font-size: 0.8em; text-transform: none;">X</button></td>`;
            });
            orderTotalCostSpan.textContent = totalCost.toLocaleString();
        }
    }
    function handleOrderSubmit(event) {
        event.preventDefault();
        if (!loggedInCustomerInfo) { alert("Please log in."); return; }
        if (currentOrderItems.length === 0) { alert("Order cart is empty."); return; }
        const orders = getFromLocalStorage(ORDERS_KEY);
        const totalCost = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const newOrder = {
            id: `order_${Date.now()}_${Math.random().toString(36).substring(2, 5)}`, customerId: loggedInCustomerInfo.id,
            customerName: loggedInCustomerInfo.name, contact: loggedInCustomerInfo.phone, email: loggedInCustomerInfo.email,
            items: currentOrderItems.map(item => ({ productId: item.id, name: item.name, price: item.price, quantity: item.quantity, userId: item.userId })), // Include owner ID per item
            totalCost, time: new Date().toISOString(), status: 'Requested'
        };
        orders.push(newOrder); saveToLocalStorage(ORDERS_KEY, orders);
        alert('Order request sent! Total: UGX ' + totalCost.toLocaleString());
        if (loggedInBusinessInfo) { displayOwnerReceivedOrders(loggedInBusinessInfo.id); } // Refresh owner view if logged in
        currentOrderItems = []; displayCurrentOrder(); // Clear cart UI
        if (currentScreen === 'profile') { displayStoredOrders(loggedInCustomerInfo.id); } // Refresh past orders if on profile screen
    }
     function displayStoredOrders(customerId) { /* Customer's Past Orders */
         const orders = getFromLocalStorage(ORDERS_KEY); ordersTableBody.innerHTML = '';
         customerOrdersStatusDiv.textContent = '';
         const relevantOrders = customerId ? orders.filter(o => o.customerId === customerId) : orders;
         if (relevantOrders.length === 0) {
             customerOrdersStatusDiv.textContent = 'No past order requests found.';
             ordersTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">You haven't placed any orders yet.</td></tr>`; return;
        }
         relevantOrders.sort((a, b) => new Date(b.time) - new Date(a.time));
         relevantOrders.forEach(order => {
             const row = ordersTableBody.insertRow();
             let itemsSummaryHtml = "<ul style='margin:0; padding-left:15px; font-size: 0.9em;'>";
             if (order.items && Array.isArray(order.items)) {
                 order.items.forEach(item => {
                     const itemPrice = typeof item.price === 'number' ? item.price : 0;
                     const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                     itemsSummaryHtml += `<li>${escapeHtml(item.name || '?')} (x${escapeHtml(itemQuantity)})</li>`;
                 });
             } else { itemsSummaryHtml += "<li>Details missing</li>"; }
             itemsSummaryHtml += "</ul>";
             row.innerHTML = `
                 <td>${itemsSummaryHtml}</td>
                 <td>${(order.totalCost || 0).toLocaleString()}</td>
                 <td>${escapeHtml(new Date(order.time).toLocaleDateString())}<br>${escapeHtml(new Date(order.time).toLocaleTimeString())}</td>
                 <td><small><i>${escapeHtml(order.status || 'Requested')}</i></small></td>`;
         });
     }

     // Display Received Orders for Owner
     function displayOwnerReceivedOrders(ownerUserId) {
         if (!ownerUserId) return;
         const allOrders = getFromLocalStorage(ORDERS_KEY);
         const allProducts = getFromLocalStorage(PRODUCTS_KEY); // Needed only to map owner's products

         ownerOrdersTableBody.innerHTML = '';
         ownerOrdersStatusDiv.textContent = '';

         // Find all product IDs belonging to this owner
         const ownerProductIds = allProducts
            .filter(p => p.userId === ownerUserId)
            .map(p => p.id);

         // Filter orders that contain at least one item from this owner
         const relevantOrders = allOrders
             .filter(order =>
                 order.items && order.items.some(item => ownerProductIds.includes(item.productId))
             ).sort((a, b) => new Date(b.time) - new Date(a.time));

         if (relevantOrders.length === 0) {
             ownerOrdersStatusDiv.textContent = 'No relevant orders received yet.';
             ownerOrdersTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">When customers order your products, they will appear here.</td></tr>`;
             return;
         }

         relevantOrders.forEach(order => {
             const row = ownerOrdersTableBody.insertRow();
             // Filter items within this order that belong to the current owner
             const itemsForThisOwner = order.items.filter(item => ownerProductIds.includes(item.productId));
             let itemsHtml = "<ul style='margin:0; padding-left: 15px; font-size:0.9em;'>";
             let ownerSubtotal = 0;
             itemsForThisOwner.forEach(item => {
                 const itemPrice = typeof item.price === 'number' ? item.price : 0;
                 const itemQuantity = typeof item.quantity === 'number' ? item.quantity : 0;
                 itemsHtml += `<li>${escapeHtml(item.name)} (x${escapeHtml(itemQuantity)}) @ ${itemPrice.toLocaleString()}</li>`;
                 ownerSubtotal += itemPrice * itemQuantity;
             });
             itemsHtml += `</ul><strong>Subtotal: ${ownerSubtotal.toLocaleString()}</strong>`;

             row.innerHTML = `
                 <td>${escapeHtml(order.customerName || 'Unknown')}</td>
                 <td>${escapeHtml(order.contact || order.email || 'N/A')}</td>
                 <td>${escapeHtml(new Date(order.time).toLocaleDateString())}<br><small>${escapeHtml(new Date(order.time).toLocaleTimeString())}</small></td>
                 <td>${itemsHtml}</td>
                 <td><small><i>${escapeHtml(order.status || 'Requested')}</i></small></td>
             `;
         });
     }


    // --- Feedback Section ---
    function handleFeedbackSubmit(event) {
         event.preventDefault(); let submitterId, submitterType, customerName, customerContact, businessName, businessContact;
        // Only customers can submit general feedback via this form now
        if (loggedInCustomerInfo) { submitterId = loggedInCustomerInfo.id; submitterType = 'customer'; customerName = loggedInCustomerInfo.name; customerContact = loggedInCustomerInfo.phone; }
        else { alert("Please log in as a customer to submit feedback."); return; }
        const feedbackList = getFromLocalStorage(FEEDBACK_KEY_V2); const feedbackText = document.getElementById('feedbackText').value.trim();
        if (!feedbackText) { alert("Please enter your feedback message."); return; }
        const newFeedback = { id: `fb_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, submitterId, submitterType, customerName: customerName || null, customerContact: customerContact || null, businessName: null, businessContact: null, productId: null, productName: 'General Feedback', text: feedbackText, time: new Date().toISOString(), status: 'New', adminReplies: [] };
        feedbackList.push(newFeedback); saveToLocalStorage(FEEDBACK_KEY_V2, feedbackList);
        alert('General feedback submitted successfully!'); feedbackForm.reset();
        if (loggedInCustomerInfo) {
            feedbackCustomerNameInput.value = loggedInCustomerInfo.name; // Reset prefilled name
            if (currentScreen === 'profile') { displayCustomerFeedbackLog(submitterId); }
        }
        if (isAdminLoggedIn) displayAdminFeedback(); // Refresh admin view
    }

    // --- Chat Functions ---
    function initiateChatWithSeller(businessUserId, businessName) {
        if (!loggedInCustomerInfo) { alert("Please log in to chat."); return; }
        // Check if the business owner is banned
         const businessOwner = getFromLocalStorage(USERS_KEY).find(u => u.id === businessUserId);
         if (!businessOwner || businessOwner.banned) { alert("Cannot initiate chat with this seller at the moment."); return; }

        const conversationId = `chat_${businessUserId}_${loggedInCustomerInfo.id}`;
        const allConversations = getFromLocalStorage(CHATS_KEY, []);
        let conversation = allConversations.find(c => c.conversationId === conversationId);
        if (!conversation) {
             conversation = { conversationId, businessUserId, businessName, businessOwnerPhoto: businessOwner?.ownerPhoto || DEFAULT_OWNER_PHOTO, customerId: loggedInCustomerInfo.id, customerContact: loggedInCustomerInfo.phone, customerName: loggedInCustomerInfo.name, messages: [], lastMessageTime: new Date().toISOString(), ownerRead: true, customerRead: true };
             allConversations.push(conversation); saveToLocalStorage(CHATS_KEY, allConversations);
             if (currentScreen === 'chats') { displayCustomerConversations(loggedInCustomerInfo.id); }
        }
        openChatModal('customer', conversationId, `Chat with ${businessName}`);
    }
    function openChatModal(userRole, conversationId, title) {
        currentOpenChat.currentUserRole = userRole; currentOpenChat.conversationId = conversationId; currentOpenChat.targetName = title;
        chatModalTitle.textContent = escapeHtml(title); chatMessagesDiv.innerHTML = '<p style="text-align:center; color:#888;">Loading messages...</p>'; chatMessageInput.value = '';
        chatMessageInput.style.height = 'auto'; // Reset height
        if (!conversationId) { console.error("No conversation ID."); chatMessagesDiv.innerHTML = '<p style="color:red;">Error: Chat ID missing.</p>'; return; }
        loadMessages(conversationId); chatModal.style.display = 'block';
        // Mark as read and refresh list view
        if (userRole === 'owner') { markConversationAsRead(conversationId, 'owner'); if (loggedInBusinessInfo) displayOwnerConversations(loggedInBusinessInfo.id); }
        else if (userRole === 'customer') { markConversationAsRead(conversationId, 'customer'); if (loggedInCustomerInfo) displayCustomerConversations(loggedInCustomerInfo.id); }
        setTimeout(() => { chatMessageInput.focus(); }, 100); // Focus input after modal opens
    }
    function closeChatModal() {
        chatModal.style.display = 'none'; currentOpenChat = { conversationId: null, targetName: null, targetUserId: null, currentUserRole: null };
    }
    function loadMessages(conversationId) {
         if (!conversationId) { chatMessagesDiv.innerHTML = '<p style="color:#888;">Error: Invalid chat.</p>'; return; }
        const conversation = getFromLocalStorage(CHATS_KEY, []).find(c => c.conversationId === conversationId); chatMessagesDiv.innerHTML = '';
        if (!conversation?.messages?.length) { chatMessagesDiv.innerHTML = '<p style="text-align:center; color:#888;">No messages yet. Start the conversation!</p>'; return; }
        conversation.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        conversation.messages.forEach(msg => { if (msg) { appendMessageToUI(msg.sender, msg.text, msg.timestamp, msg.messageId, msg.deleted); } });
        scrollToChatBottom();
    }
    function sendMessage() {
        const messageText = chatMessageInput.value.trim();
        if (!messageText || !currentOpenChat.conversationId || !currentOpenChat.currentUserRole) { console.error("Cannot send: Missing data", currentOpenChat); return; }
        const senderRole = currentOpenChat.currentUserRole; const conversationId = currentOpenChat.conversationId;
        const allConversations = getFromLocalStorage(CHATS_KEY, []);
        const conversationIndex = allConversations.findIndex(c => c.conversationId === conversationId);
        if (conversationIndex === -1) { console.error("Error finding conversation:", conversationId); alert("Error sending message."); return; }
        const conversation = allConversations[conversationIndex]; const timestamp = new Date().toISOString(); const messageId = `msg_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        const newMessage = { messageId, sender: senderRole, text: messageText, timestamp, deleted: false };
        if (!conversation.messages) conversation.messages = []; conversation.messages.push(newMessage); conversation.lastMessageTime = timestamp;
        // Update read status
        if (senderRole === 'customer') { conversation.ownerRead = false; conversation.customerRead = true; }
        else { conversation.customerRead = false; conversation.ownerRead = true; } // Assuming 'owner' is the sender if not customer
        saveToLocalStorage(CHATS_KEY, allConversations); appendMessageToUI(senderRole, messageText, timestamp, messageId, false);
        chatMessageInput.value = ''; chatMessageInput.style.height = 'auto'; scrollToChatBottom();
        // Refresh the chat list view immediately
        if (senderRole === 'owner' && loggedInBusinessInfo) { displayOwnerConversations(loggedInBusinessInfo.id); }
        else if (senderRole === 'customer' && loggedInCustomerInfo) { displayCustomerConversations(loggedInCustomerInfo.id); }
    }
    function appendMessageToUI(sender, text, timestamp, messageId, isDeleted) {
        const placeholder = chatMessagesDiv.querySelector('p'); if (placeholder && (placeholder.textContent.includes("No messages") || placeholder.textContent.includes("Loading"))) { chatMessagesDiv.innerHTML = ''; }
        const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message'); messageDiv.dataset.messageId = messageId;
        const isMyMessage = sender === currentOpenChat.currentUserRole;
        if (isDeleted) { messageDiv.classList.add('deleted'); messageDiv.innerHTML = `<span>[Message deleted]</span>`; }
        else {
             messageDiv.classList.add(sender === 'customer' ? 'sender-customer' : 'sender-owner'); // Treat non-customer as owner for styling
             const time = new Date(timestamp); const formattedTime = time.toLocaleTimeString ? time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
             messageDiv.innerHTML = `<span style="white-space: pre-wrap;">${escapeHtml(text)}</span><span class="msg-time">${formattedTime}</span>`;
             // Add delete button only if it's the sender's own message
             if (isMyMessage) {
                 const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-msg-btn'; deleteBtn.title = 'Delete message'; deleteBtn.innerHTML = '<i class="material-icons">delete_outline</i>';
                 messageDiv.appendChild(deleteBtn);
             }
        } chatMessagesDiv.appendChild(messageDiv);
    }
    function scrollToChatBottom() { chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; }
    function handleDeleteMessage(conversationId, messageId) {
         if (!confirm("Delete this message? This cannot be undone.")) { return; }
         const allConversations = getFromLocalStorage(CHATS_KEY, []); const conversationIndex = allConversations.findIndex(c => c.conversationId === conversationId); if (conversationIndex === -1) return;
         const conversation = allConversations[conversationIndex]; if (!conversation.messages) return; const messageIndex = conversation.messages.findIndex(m => m?.messageId === messageId); if (messageIndex === -1) return;
         // Check if the logged-in user is the sender of the message
         if (conversation.messages[messageIndex].sender !== currentOpenChat.currentUserRole) { alert("You can only delete your own messages."); return; }
         conversation.messages[messageIndex].deleted = true; conversation.messages[messageIndex].text = "[Message deleted]"; saveToLocalStorage(CHATS_KEY, allConversations);
         // Update the UI
         const messageDiv = chatMessagesDiv.querySelector(`.chat-message[data-message-id="${messageId}"]`);
         if (messageDiv) { messageDiv.classList.add('deleted'); messageDiv.classList.remove('sender-customer', 'sender-owner'); messageDiv.innerHTML = `<span>[Message deleted]</span>`; }
         // Refresh chat list if needed (to update last message snippet)
         if(loggedInBusinessInfo) displayOwnerConversations(loggedInBusinessInfo.id); if(loggedInCustomerInfo) displayCustomerConversations(loggedInCustomerInfo.id);
    }
    function displayOwnerConversations(ownerUserId) {
        if (!ownerUserId) return;
        const ownerConversations = getFromLocalStorage(CHATS_KEY, []).filter(c => c.businessUserId === ownerUserId);
        ownerChatListUl.innerHTML = ''; ownerChatsSection.style.display = 'block'; customerChatsSection.style.display = 'none';
        if (ownerConversations.length === 0) { ownerChatStatusP.textContent = 'No customer chats yet.'; ownerChatStatusP.style.display = 'block'; return; }
        ownerChatStatusP.style.display = 'none'; ownerConversations.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
        ownerConversations.forEach(convo => {
            const li = document.createElement('li'); li.dataset.conversationId = convo.conversationId; li.dataset.customerContact = convo.customerContact || convo.customerName;
            const lastMsg = convo.messages?.length ? [...convo.messages].filter(m => !m.deleted).pop() : null; let snippet = lastMsg ? escapeHtml(lastMsg.text) : (convo.messages?.length ? "<i>[Message deleted]</i>" : "[No messages]"); let lastTime = lastMsg ? lastMsg.timestamp : convo.lastMessageTime; if (lastMsg && lastMsg.sender === 'owner') { snippet = `You: ${snippet}`; }
            const time = new Date(lastTime); const formattedTime = time.toLocaleDateString ? time.toLocaleDateString([], { month:'short', day:'numeric'}) : ''; const isUnread = !convo.ownerRead;
            li.innerHTML = `
                <div class="chat-list-info"> <span class="customer-contact" style="${isUnread ? 'font-weight:bold;' : ''}">${escapeHtml(convo.customerName || convo.customerContact || 'Customer')}</span> <span class="last-message" style="${isUnread ? 'font-weight:bold; color:#333;' : ''}">${snippet.substring(0, 40)}${snippet.length > 40 ? '...' : ''}</span> </div>
                <div class="chat-time"> ${formattedTime} ${isUnread ? '<span class="new-message-indicator">New</span>' : ''} </div>`;
             ownerChatListUl.appendChild(li);
        });
    }
    function displayCustomerConversations(customerId) {
        if (!customerId) return;
        const customerConversations = getFromLocalStorage(CHATS_KEY, []).filter(c => c.customerId === customerId);
        customerChatListUl.innerHTML = ''; customerChatsSection.style.display = 'block'; ownerChatsSection.style.display = 'none';
        if (customerConversations.length === 0) { customerChatStatusP.textContent = 'No chats initiated yet. Find a product and click "Chat".'; customerChatStatusP.style.display = 'block'; return; }
        customerChatStatusP.style.display = 'none'; customerConversations.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
        customerConversations.forEach(convo => {
             const li = document.createElement('li'); li.dataset.conversationId = convo.conversationId; li.dataset.businessName = convo.businessName;
             const lastMsg = convo.messages?.length ? [...convo.messages].filter(m => !m.deleted).pop() : null; let snippet = lastMsg ? escapeHtml(lastMsg.text) : (convo.messages?.length ? "<i>[Message deleted]</i>" : "[No messages]"); let lastTime = lastMsg ? lastMsg.timestamp : convo.lastMessageTime; if (lastMsg && lastMsg.sender === 'customer') { snippet = `You: ${snippet}`; }
             const time = new Date(lastTime); const formattedTime = time.toLocaleDateString ? time.toLocaleDateString([], { month:'short', day:'numeric'}) : ''; const isUnread = !convo.customerRead;
             li.innerHTML = `
                 <div class="chat-list-info"> <span class="business-name" style="${isUnread ? 'font-weight:bold;' : ''}">${escapeHtml(convo.businessName || 'Business')}</span> <span class="last-message" style="${isUnread ? 'font-weight:bold; color:#333;' : ''}">${snippet.substring(0, 40)}${snippet.length > 40 ? '...' : ''}</span> </div>
                 <div class="chat-time"> ${formattedTime} ${isUnread ? '<span class="new-message-indicator">New</span>' : ''} </div>`;
             customerChatListUl.appendChild(li);
        });
    }
     function markConversationAsRead(conversationId, userRole) {
         const allConversations = getFromLocalStorage(CHATS_KEY, []); const conversationIndex = allConversations.findIndex(c => c.conversationId === conversationId);
         if (conversationIndex > -1) { if (userRole === 'owner') allConversations[conversationIndex].ownerRead = true; else if (userRole === 'customer') allConversations[conversationIndex].customerRead = true; saveToLocalStorage(CHATS_KEY, allConversations); }
      }

    // --- Change Password Functions ---
    function handleChangeOwnerPassword(event) {
        event.preventDefault(); ownerChangePwdErrorDiv.textContent = ''; ownerChangePwdSuccessDiv.textContent = '';
        if (!loggedInBusinessInfo) { ownerChangePwdErrorDiv.textContent = 'Not logged in.'; return; }
        const currentPassword = document.getElementById('ownerCurrentPassword').value; const newPassword = document.getElementById('ownerNewPassword').value; const confirmPassword = document.getElementById('ownerConfirmPassword').value;
        if (!currentPassword || !newPassword || !confirmPassword) { ownerChangePwdErrorDiv.textContent = 'All fields required.'; return; } if (newPassword.length < 6) { ownerChangePwdErrorDiv.textContent = 'New password min 6 chars.'; return; } if (newPassword !== confirmPassword) { ownerChangePwdErrorDiv.textContent = 'New passwords do not match.'; return; }
        const users = getFromLocalStorage(USERS_KEY); const userIndex = users.findIndex(u => u.id === loggedInBusinessInfo.id); if (userIndex === -1) { ownerChangePwdErrorDiv.textContent = 'Error: User not found.'; return; }
        if (users[userIndex].password !== currentPassword) { ownerChangePwdErrorDiv.textContent = 'Incorrect current password.'; return; } if (users[userIndex].password === newPassword) { ownerChangePwdErrorDiv.textContent = 'New password cannot be the same as old.'; return; }
        users[userIndex].password = newPassword; saveToLocalStorage(USERS_KEY, users);
        ownerChangePwdSuccessDiv.textContent = 'Password changed successfully!'; ownerChangePasswordForm.reset();
        setTimeout(() => { const contentElement = document.getElementById('owner-change-password-content'); const headerElement = contentElement.previousElementSibling; contentElement.classList.remove('is-visible'); headerElement.classList.remove('is-open'); ownerChangePwdSuccessDiv.textContent = ''; }, 2500);
    }
    function handleChangeCustomerPassword(event) {
         event.preventDefault(); customerChangePwdErrorDiv.textContent = ''; customerChangePwdSuccessDiv.textContent = '';
        if (!loggedInCustomerInfo) { customerChangePwdErrorDiv.textContent = 'Not logged in.'; return; }
        const currentPassword = document.getElementById('customerCurrentPassword').value; const newPassword = document.getElementById('customerNewPassword').value; const confirmPassword = document.getElementById('customerConfirmPassword').value;
        if (!currentPassword || !newPassword || !confirmPassword) { customerChangePwdErrorDiv.textContent = 'All fields required.'; return; } if (newPassword.length < 6) { customerChangePwdErrorDiv.textContent = 'New password min 6 chars.'; return; } if (newPassword !== confirmPassword) { customerChangePwdErrorDiv.textContent = 'New passwords do not match.'; return; }
        const customers = getFromLocalStorage(CUSTOMER_ACCOUNTS_KEY); const customerIndex = customers.findIndex(c => c.id === loggedInCustomerInfo.id); if (customerIndex === -1) { customerChangePwdErrorDiv.textContent = 'Error: Account not found.'; return; }
        if (customers[customerIndex].password !== currentPassword) { customerChangePwdErrorDiv.textContent = 'Incorrect current password.'; return; } if (customers[customerIndex].password === newPassword) { customerChangePwdErrorDiv.textContent = 'New password cannot be same as old.'; return; }
        customers[customerIndex].password = newPassword; saveToLocalStorage(CUSTOMER_ACCOUNTS_KEY, customers);
        customerChangePwdSuccessDiv.textContent = 'Password changed successfully!'; customerChangePasswordForm.reset();
        setTimeout(() => { const contentElement = document.getElementById('customer-change-password-content'); const headerElement = contentElement.previousElementSibling; contentElement.classList.remove('is-visible'); headerElement.classList.remove('is-open'); customerChangePwdSuccessDiv.textContent = ''; }, 2500);
    }
    function handleChangeAdminPassword(event) {
        event.preventDefault();
        adminChangePwdErrorDiv.textContent = '';
        adminChangePwdSuccessDiv.textContent = '';

        if (!isAdminLoggedIn) {
            adminChangePwdErrorDiv.textContent = 'Not logged in as admin.';
            return;
        }

        const currentPassword = document.getElementById('adminCurrentPassword').value;
        const newPassword = document.getElementById('adminNewPassword').value;
        const confirmPassword = document.getElementById('adminConfirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            adminChangePwdErrorDiv.textContent = 'All fields required.';
            return;
        }
        if (newPassword.length < 6) {
            adminChangePwdErrorDiv.textContent = 'New password must be at least 6 characters.';
            return;
        }
        if (newPassword !== confirmPassword) {
            adminChangePwdErrorDiv.textContent = 'New passwords do not match.';
            return;
        }
        // ** INSECURE ** Compare with the current runtime password
        if (currentPassword !== ADMIN_PASSWORD) {
            adminChangePwdErrorDiv.textContent = 'Incorrect current admin password.';
            return;
        }
        if (newPassword === ADMIN_PASSWORD) {
            adminChangePwdErrorDiv.textContent = 'New password cannot be the same as the old one.';
            return;
        }

        // ** INSECURE ** Update the runtime variable ONLY. Does not persist.
        ADMIN_PASSWORD = newPassword;

        adminChangePwdSuccessDiv.textContent = 'Admin password updated for this session only!';
        adminChangePasswordForm.reset();

        // Close the section after success
        setTimeout(() => {
            const contentElement = document.getElementById('admin-change-password-content');
            const headerElement = contentElement.previousElementSibling;
            contentElement.classList.remove('is-visible');
            headerElement.classList.remove('is-open');
            adminChangePwdSuccessDiv.textContent = '';
        }, 3000);
    }
    // NEW: Handle Police Password Change (if needed, similar insecure structure)
    // function handleChangePolicePassword(event) { ... }

    // --- Admin Panel & Feedback Management ---
    function displayAdminBusinessOwners() {
        const users = getFromLocalStorage(USERS_KEY); adminBusinessOwnersTableBody.innerHTML = '';
        adminOwnersStatusDiv.textContent = '';
        if (users.length === 0) {
             adminOwnersStatusDiv.textContent = 'No business owners found.';
             adminBusinessOwnersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No businesses have registered yet.</td></tr>'; return;
        }
        users.sort((a, b) => (a.businessName || '').localeCompare(b.businessName || ''));
        users.forEach(user => {
            const row = adminBusinessOwnersTableBody.insertRow(); row.className = user.banned ? 'banned-user' : '';
            const locationAdminDisplay = escapeHtml(user.district || '') + (user.specificLocation ? ` / ${escapeHtml(user.specificLocation)}` : '');
            row.innerHTML = `
                <td>${escapeHtml(user.businessName)}<br><small>${escapeHtml(user.email)}</small></td> <td>${escapeHtml(user.phone)}</td> <td>${locationAdminDisplay}</td> <td>${user.banned ? 'Banned' : 'Active'}</td>
                <td> <div class="action-buttons-group"> ${user.banned ? `<button class="warning small unban-btn" data-user-id="${user.id}">Unban</button>` : `<button class="danger small ban-btn" data-user-id="${user.id}">Ban</button>`} <button class="secondary small reset-pwd-btn" data-user-id="${user.id}">Reset Pwd</button> </div> </td>`;
        });
    }
    function displayAdminCustomers() {
        const customers = getFromLocalStorage(CUSTOMER_ACCOUNTS_KEY); adminCustomersTableBody.innerHTML = '';
        adminCustomersStatusDiv.textContent = '';
        if (customers.length === 0) {
            adminCustomersStatusDiv.textContent = 'No customers found.';
            adminCustomersTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No customers have registered yet.</td></tr>'; return;
        }
        customers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        customers.forEach(cust => {
            const row = adminCustomersTableBody.insertRow(); row.className = cust.banned ? 'banned-user' : '';
            row.innerHTML = `
                <td>${escapeHtml(cust.name)}</td> <td>${escapeHtml(cust.email)}<br><small>${escapeHtml(cust.phone)}</small></td> <td>${cust.banned ? 'Banned' : 'Active'}</td>
                 <td> <div class="action-buttons-group"> ${cust.banned ? `<button class="warning small unban-btn" data-user-id="${cust.id}">Unban</button>` : `<button class="danger small ban-btn" data-user-id="${cust.id}">Ban</button>`} <button class="secondary small reset-pwd-btn" data-user-id="${cust.id}">Reset Pwd</button> </div> </td>`;
        });
    }
    function displayAdminFeedback() {
        const feedbackList = getFromLocalStorage(FEEDBACK_KEY_V2); adminFeedbackTableBody.innerHTML = '';
        adminFeedbackStatusDiv.textContent = '';
        if (feedbackList.length === 0) {
            adminFeedbackStatusDiv.textContent = 'No general feedback submitted.';
            adminFeedbackTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No feedback received yet.</td></tr>'; return;
        }
        feedbackList.sort((a, b) => new Date(b.time) - new Date(a.time));
        feedbackList.forEach(fb => {
            const row = adminFeedbackTableBody.insertRow(); const submitterName = fb.submitterType === 'customer' ? fb.customerName : (fb.businessName || 'Business'); const submitterContact = fb.submitterType === 'customer' ? fb.customerContact : (fb.businessContact || 'N/A'); let statusClass = ''; if (fb.status === 'Replied') statusClass = 'feedback-status-replied'; else if (fb.status === 'Closed') statusClass = 'feedback-status-closed'; else statusClass = 'feedback-status-new';
            row.innerHTML = `
                <td>${escapeHtml(submitterName)}<br><small>(${escapeHtml(submitterContact)})</small></td> <td>${escapeHtml(fb.text)}<br><small>${escapeHtml(new Date(fb.time).toLocaleString())}</small></td> <td class="${statusClass}">${escapeHtml(fb.status || 'New')}</td>
                <td> <div class="action-buttons-group"> ${fb.status !== 'Closed' ? `<button class="info small reply-feedback-btn" data-feedback-id="${fb.id}">Reply</button>` : ''} ${(fb.status === 'Replied' || fb.status === 'New') ? `<button class="secondary small close-feedback-btn" data-feedback-id="${fb.id}">Close</button>` : ''} ${fb.status === 'Closed' ? '<span>Closed</span>' : ''} </div> </td>`;
        });
    }
    function handleBanUser(userId, userType, shouldBan) {
        if (!isAdminLoggedIn) return; if (!confirm(shouldBan ? `Ban this ${userType}?` : `Unban this ${userType}?`)) return;
        const storageKey = userType === 'business' ? USERS_KEY : CUSTOMER_ACCOUNTS_KEY; const users = getFromLocalStorage(storageKey); const userIndex = users.findIndex(u => u.id === userId);
        if (userIndex > -1) { users[userIndex].banned = shouldBan; saveToLocalStorage(storageKey, users); alert(`User ${shouldBan ? 'banned' : 'unbanned'}.`); if (userType === 'business') displayAdminBusinessOwners(); else displayAdminCustomers(); } else { alert('Error: User not found.'); }
    }
    function handleAdminPasswordReset(userId, userType) {
         if (!isAdminLoggedIn) { alert("Admin permission required."); return; }
         const storageKey = userType === 'business' ? USERS_KEY : CUSTOMER_ACCOUNTS_KEY; const users = getFromLocalStorage(storageKey); const userIndex = users.findIndex(u => u.id === userId); if (userIndex === -1) { alert(`Error: ${userType} user not found.`); return; }
         const userName = userType === 'business' ? users[userIndex].businessName : users[userIndex].name; const userIdentifier = userType === 'business' ? users[userIndex].email : `${users[userIndex].email} / ${users[userIndex].phone}`;
         const tempPassword = prompt(`Enter NEW temporary password for ${userType} "${escapeHtml(userName)}" (${escapeHtml(userIdentifier)}):`);
         if (!tempPassword) { alert("Password reset cancelled."); return; } if (tempPassword.length < 6) { alert("Password must be at least 6 characters long."); return; }
         if (confirm(`CONFIRM: Reset password for ${userType} "${escapeHtml(userName)}" to "${tempPassword}"?\n\n!!! IMPORTANT !!!\nYou MUST securely communicate this temporary password to the user outside of this app!`)) { users[userIndex].password = tempPassword; saveToLocalStorage(storageKey, users); alert(`Password for ${userType} "${escapeHtml(userName)}" has been reset to: ${tempPassword}\n\nPlease inform the user immediately using a secure method.`); } else { alert("Password reset cancelled."); }
    }
    // NEW: Admin creates Police Account
    function handleCreatePoliceAccount(event) {
        event.preventDefault();
        if (!isAdminLoggedIn) return;
        createPoliceMsgDiv.textContent = ''; createPoliceMsgDiv.className = 'success-message';

        const name = document.getElementById('policeName').value.trim();
        const policeId = document.getElementById('policeId').value.trim();
        const password = document.getElementById('policePassword').value;

        if (!name || !policeId || !password) {
            createPoliceMsgDiv.textContent = 'All fields are required.';
            createPoliceMsgDiv.className = 'error-message'; return;
        }
        if (password.length < 6) {
            createPoliceMsgDiv.textContent = 'Password must be at least 6 characters.';
            createPoliceMsgDiv.className = 'error-message'; return;
        }

        const policeAccounts = getFromLocalStorage(POLICE_ACCOUNTS_KEY);
        if (policeAccounts.some(p => p.policeId === policeId)) {
            createPoliceMsgDiv.textContent = 'Police ID already exists.';
            createPoliceMsgDiv.className = 'error-message'; return;
        }

        const newPoliceAccount = {
            name: name,
            policeId: policeId,
            password: password, // ** INSECURE: Storing plain text **
            registrationDate: new Date().toISOString()
        };

        policeAccounts.push(newPoliceAccount);
        saveToLocalStorage(POLICE_ACCOUNTS_KEY, policeAccounts);

        createPoliceMsgDiv.textContent = 'Police account created successfully!';
        createPoliceAccountForm.reset();
        displayAdminPoliceAccounts(); // Refresh the list

        setTimeout(() => { createPoliceMsgDiv.textContent = ''; }, 3000);
    }
    // NEW: Admin displays Police Accounts
    function displayAdminPoliceAccounts() {
        const policeAccounts = getFromLocalStorage(POLICE_ACCOUNTS_KEY);
        adminPoliceAccountsTableBody.innerHTML = '';
        adminPoliceStatusDiv.textContent = '';

        if (policeAccounts.length === 0) {
            adminPoliceStatusDiv.textContent = 'No police accounts created yet.';
            adminPoliceAccountsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Use the form above to create accounts.</td></tr>';
            return;
        }

        policeAccounts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        policeAccounts.forEach(account => {
            const row = adminPoliceAccountsTableBody.insertRow();
            row.innerHTML = `
                <td>${escapeHtml(account.name)}</td>
                <td>${escapeHtml(account.policeId)}</td>
                <td>
                    <div class="action-buttons-group">
                        <button class="danger small delete-police-btn" data-police-id="${account.policeId}">Delete</button>
                        <!-- Add Reset Password / Ban if needed -->
                    </div>
                </td>
            `;
        });
    }
    // NEW: Admin deletes Police Account
    function handleDeletePoliceAccount(policeId) {
        if (!isAdminLoggedIn) return;
        if (!confirm(`Are you sure you want to delete police account ID: ${escapeHtml(policeId)}? This cannot be undone.`)) return;

        let policeAccounts = getFromLocalStorage(POLICE_ACCOUNTS_KEY);
        const initialLength = policeAccounts.length;
        policeAccounts = policeAccounts.filter(p => p.policeId !== policeId);

        if (policeAccounts.length < initialLength) {
            saveToLocalStorage(POLICE_ACCOUNTS_KEY, policeAccounts);
            alert('Police account deleted.');
            displayAdminPoliceAccounts(); // Refresh list
        } else {
            alert('Error: Police account not found.');
        }
    }


    // Display General Feedback Logs
    function displayOwnerFeedbackLog(ownerId) {
         const ownerFeedback = getFromLocalStorage(FEEDBACK_KEY_V2).filter(fb => fb.submitterId === ownerId && fb.submitterType === 'owner'); ownerFeedbackLogTableBody.innerHTML = '';
         ownerFeedbackStatusDiv.textContent = '';
        if (ownerFeedback.length === 0) {
            ownerFeedbackStatusDiv.textContent = 'No general feedback submitted by you.';
            ownerFeedbackLogTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">You have not submitted any general feedback.</td></tr>'; return;
        }
        ownerFeedback.sort((a, b) => new Date(b.time) - new Date(a.time));
        ownerFeedback.forEach(fb => { const row = ownerFeedbackLogTableBody.insertRow(); let repliesHtml = fb.adminReplies?.length > 0 ? fb.adminReplies.map(r => `<div class="admin-reply"><strong>Admin (${new Date(r.timestamp).toLocaleDateString()}):</strong> ${escapeHtml(r.text)}</div>`).join('') : '<i>No reply yet</i>'; let statusClass = ''; if (fb.status === 'Replied') statusClass = 'feedback-status-replied'; else if (fb.status === 'Closed') statusClass = 'feedback-status-closed'; else statusClass = 'feedback-status-new'; row.innerHTML = `<td>${escapeHtml(fb.text)}</td><td>${escapeHtml(new Date(fb.time).toLocaleDateString())}</td><td>${repliesHtml}</td><td class="${statusClass}">${escapeHtml(fb.status || 'New')}</td>`; });
    }
    function displayCustomerFeedbackLog(customerId) {
         const customerFeedback = getFromLocalStorage(FEEDBACK_KEY_V2).filter(fb => fb.submitterId === customerId && fb.submitterType === 'customer'); customerFeedbackLogTableBody.innerHTML = '';
         customerFeedbackStatusDiv.textContent = '';
        if (customerFeedback.length === 0) {
             customerFeedbackStatusDiv.textContent = 'No general feedback submitted by you.';
             customerFeedbackLogTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Use the form above to submit feedback.</td></tr>'; return;
        }
        customerFeedback.sort((a, b) => new Date(b.time) - new Date(a.time));
        customerFeedback.forEach(fb => { const row = customerFeedbackLogTableBody.insertRow(); let repliesHtml = fb.adminReplies?.length > 0 ? fb.adminReplies.map(r => `<div class="admin-reply"><strong>Admin (${new Date(r.timestamp).toLocaleDateString()}):</strong> ${escapeHtml(r.text)}</div>`).join('') : '<i>No reply yet</i>'; let statusClass = ''; if (fb.status === 'Replied') statusClass = 'feedback-status-replied'; else if (fb.status === 'Closed') statusClass = 'feedback-status-closed'; else statusClass = 'feedback-status-new'; row.innerHTML = `<td>${escapeHtml(fb.text)}</td><td>${escapeHtml(new Date(fb.time).toLocaleDateString())}</td><td>${repliesHtml}</td><td class="${statusClass}">${escapeHtml(fb.status || 'New')}</td>`; });
    }

    // Feedback Reply Modal Functions
    function openFeedbackReplyModal(feedbackId) {
        if (!isAdminLoggedIn) return; const feedbackItem = getFromLocalStorage(FEEDBACK_KEY_V2).find(fb => fb.id === feedbackId); if (!feedbackItem) { alert('Error: Feedback not found.'); return; }
        feedbackReplyIdInput.value = feedbackId; feedbackReplyOriginalMessageDiv.innerHTML = `<strong>Original Feedback (${escapeHtml(feedbackItem.productName || 'General')}):</strong><br>${escapeHtml(feedbackItem.text)}`; feedbackReplyExistingRepliesDiv.innerHTML = '<strong>Admin Replies:</strong><br>';
        if (feedbackItem.adminReplies?.length > 0) { feedbackItem.adminReplies.forEach(reply => { feedbackReplyExistingRepliesDiv.innerHTML += `<div><strong>${new Date(reply.timestamp).toLocaleString()}:</strong><br>${escapeHtml(reply.text)}</div>`; }); } else { feedbackReplyExistingRepliesDiv.innerHTML += '<i>No previous replies.</i>'; }
        feedbackReplyTextarea.value = ''; feedbackReplyModal.style.display = 'block'; setTimeout(() => feedbackReplyTextarea.focus(), 50);
    }
    function closeFeedbackReplyModal() { feedbackReplyModal.style.display = 'none'; }
    function handleFeedbackReplySubmit(event) {
         event.preventDefault(); if (!isAdminLoggedIn) return; const feedbackId = feedbackReplyIdInput.value; const replyText = feedbackReplyTextarea.value.trim(); if (!feedbackId || !replyText) { alert('Reply cannot be empty.'); return; }
        const feedbackList = getFromLocalStorage(FEEDBACK_KEY_V2); const feedbackIndex = feedbackList.findIndex(fb => fb.id === feedbackId); if (feedbackIndex === -1) { alert('Error: Feedback not found.'); return; }
        const newReply = { text: replyText, timestamp: new Date().toISOString() };
        if (!feedbackList[feedbackIndex].adminReplies) { feedbackList[feedbackIndex].adminReplies = []; } feedbackList[feedbackIndex].adminReplies.push(newReply); feedbackList[feedbackIndex].status = 'Replied';
        saveToLocalStorage(FEEDBACK_KEY_V2, feedbackList); alert('Reply sent successfully.'); closeFeedbackReplyModal(); displayAdminFeedback();
        // Refresh user's view if they are on profile screen
        const updatedFeedback = feedbackList[feedbackIndex]; if (currentScreen === 'profile') { if(updatedFeedback.submitterType === 'customer' && loggedInCustomerInfo?.id === updatedFeedback.submitterId) { displayCustomerFeedbackLog(updatedFeedback.submitterId); } else if (updatedFeedback.submitterType === 'owner' && loggedInBusinessInfo?.id === updatedFeedback.submitterId) { displayOwnerFeedbackLog(updatedFeedback.submitterId); } }
    }
    function handleCloseFeedback(feedbackId) {
         if (!isAdminLoggedIn) return; if (!confirm("Mark this feedback thread as closed? No further replies will be possible.")) return; const feedbackList = getFromLocalStorage(FEEDBACK_KEY_V2); const feedbackIndex = feedbackList.findIndex(fb => fb.id === feedbackId);
         if (feedbackIndex > -1) { feedbackList[feedbackIndex].status = 'Closed'; saveToLocalStorage(FEEDBACK_KEY_V2, feedbackList); alert('Feedback thread closed.'); displayAdminFeedback();
             // Refresh user's view if they are on profile screen
             const updatedFeedback = feedbackList[feedbackIndex]; if (currentScreen === 'profile') { if(updatedFeedback.submitterType === 'customer' && loggedInCustomerInfo?.id === updatedFeedback.submitterId) { displayCustomerFeedbackLog(updatedFeedback.submitterId); } else if (updatedFeedback.submitterType === 'owner' && loggedInBusinessInfo?.id === updatedFeedback.submitterId) { displayOwnerFeedbackLog(updatedFeedback.submitterId); } }
        } else { alert('Error: Feedback not found.'); }
    }

    // --- Ratings & Comments Functions ---
    function getRatingsComments(targetType, targetId) {
        const allRatings = getFromLocalStorage(RATINGS_COMMENTS_KEY); return allRatings.filter(r => r.targetType === targetType && r.targetId === targetId);
    }
    function calculateAverageRating(targetType, targetId) {
        const relevantRatings = getRatingsComments(targetType, targetId); if (relevantRatings.length === 0) { return { average: 0, count: 0 }; }
        const sum = relevantRatings.reduce((acc, r) => acc + (r.rating || 0), 0); return { average: sum / relevantRatings.length, count: relevantRatings.length };
    }
    function openRatingsModal(targetType, targetId) {
        if (!targetId) return; const product = getFromLocalStorage(PRODUCTS_KEY).find(p => p.id === targetId); if (!product) { alert("Product details not found."); return; }
        ratingTargetIdInput.value = targetId; ratingTargetTypeInput.value = targetType; ratingsProductName.textContent = escapeHtml(product.name); ratingsModalTitle.textContent = `Ratings for ${escapeHtml(product.name)}`;
        displayRatingsAndComments(targetType, targetId); addRatingForm.reset(); selectedRating = 0; ratingValueInput.value = ''; updateStarSelectionUI(); addRatingErrorDiv.textContent = ''; ratingsModal.style.display = 'block';
    }
    function closeRatingsModal() { ratingsModal.style.display = 'none'; }
    function displayRatingsAndComments(targetType, targetId) {
        const { average, count } = calculateAverageRating(targetType, targetId); renderStars(average, ratingsAverageStarsSpan); ratingsCountSpan.textContent = count;
        const comments = getRatingsComments(targetType, targetId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); ratingsListDiv.innerHTML = '';
        if (comments.length === 0) { ratingsListDiv.innerHTML = '<p><i>No ratings or comments yet. Be the first!</i></p>'; }
        else { comments.forEach(rc => { const itemDiv = document.createElement('div'); itemDiv.className = 'rating-item'; const starsHtml = `<span class="stars"></span>`; itemDiv.innerHTML = ` ${starsHtml} ${rc.comment ? `<blockquote>${escapeHtml(rc.comment)}</blockquote>` : ''} <div class="rating-meta">By: ${escapeHtml(rc.customerName || 'Anonymous')} on ${new Date(rc.timestamp).toLocaleDateString()}</div> `; ratingsListDiv.appendChild(itemDiv); renderStars(rc.rating, itemDiv.querySelector('.stars')); }); }
        // Show/hide add rating form based on login status
        addRatingForm.style.display = loggedInCustomerInfo ? 'block' : 'none';
        // Remove any previous login messages
        const existingLoginMsg = ratingsModal.querySelector('.login-to-rate-msg');
        if (existingLoginMsg) existingLoginMsg.remove();
        if (!loggedInCustomerInfo) { ratingsListDiv.insertAdjacentHTML('afterend', '<p class="login-to-rate-msg" style="margin-top:15px;"><i>Log in as a customer to add your rating.</i></p>'); }
    }
    function handleAddRatingSubmit(event) {
        event.preventDefault(); addRatingErrorDiv.textContent = ''; if (!loggedInCustomerInfo) { addRatingErrorDiv.textContent = 'You must be logged in as a customer to rate products.'; return; }
        const targetId = ratingTargetIdInput.value; const targetType = ratingTargetTypeInput.value; const rating = parseInt(ratingValueInput.value, 10); const comment = ratingCommentTextarea.value.trim();
        if (!targetId || !targetType) { addRatingErrorDiv.textContent = 'Error: Target product not identified.'; return; } if (!rating || rating < 1 || rating > 5) { addRatingErrorDiv.textContent = 'Please select a rating (1-5 stars).'; return; }
        addRatingComment(targetType, targetId, rating, comment);
    }
    function addRatingComment(targetType, targetId, rating, comment) {
        if (!loggedInCustomerInfo) return; const allRatings = getFromLocalStorage(RATINGS_COMMENTS_KEY);
        const newRating = { id: `rc_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, targetType, targetId, customerId: loggedInCustomerInfo.id, customerName: loggedInCustomerInfo.name, rating, comment: comment || null, timestamp: new Date().toISOString() };
        allRatings.push(newRating); saveToLocalStorage(RATINGS_COMMENTS_KEY, allRatings); displayRatingsAndComments(targetType, targetId); // Refresh modal content
        addRatingForm.reset(); selectedRating = 0; ratingValueInput.value = ''; updateStarSelectionUI(); addRatingErrorDiv.textContent = '';
        // Success message
        const successMsg = document.createElement('div'); successMsg.className = 'success-message'; successMsg.textContent = 'Rating submitted successfully!'; addRatingForm.insertAdjacentElement('beforebegin', successMsg); setTimeout(() => successMsg.remove(), 2500);
        // Refresh product list if on home screen to update rating display there
        setTimeout(() => { if (currentScreen === 'home' && !loggedInBusinessInfo && !loggedInPoliceInfo) { loadFilteredProducts(); } }, 500);
    }


    // --- Adverts/Announcements Functions ---

    async function handleOwnerUploadAdvert(event) {
        event.preventDefault();
        if (!loggedInBusinessInfo) { alert("Session expired."); handleLogout('owner'); return; }

        const title = document.getElementById('ownerAdvertTitle').value.trim();
        const content = document.getElementById('ownerAdvertContent').value.trim();
        const imageFile = document.getElementById('ownerAdvertImage').files[0];
        ownerAdvertMsgDiv.textContent = ''; ownerAdvertMsgDiv.className = 'success-message'; // Reset message

        if (!title || !content) {
            ownerAdvertMsgDiv.textContent = 'Title and Content are required.';
            ownerAdvertMsgDiv.className = 'error-message'; return;
        }

        let imageDataUrl = null;
        if (imageFile) {
            try { imageDataUrl = await readFileAsDataURL(imageFile); }
            catch (error) {
                console.error("Error reading advert image:", error);
                ownerAdvertMsgDiv.textContent = 'Error processing image file.';
                ownerAdvertMsgDiv.className = 'error-message'; return;
            }
        }

        const adverts = getFromLocalStorage(WANO_ADVERTS_KEY);
        const newAdvert = {
            id: `advert_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
            uploaderId: loggedInBusinessInfo.id, uploaderType: 'owner',
            uploaderName: loggedInBusinessInfo.businessName, title, content,
            image: imageDataUrl, timestamp: new Date().toISOString(),
            targetAudience: 'customers' // Owners target customers
        };

        adverts.push(newAdvert); saveToLocalStorage(WANO_ADVERTS_KEY, adverts);
        ownerAdvertMsgDiv.textContent = 'Advert uploaded successfully!'; ownerAdvertForm.reset();
        setTimeout(() => { ownerAdvertMsgDiv.textContent = ''; }, 3000);
        if (currentScreen === 'adverts') { displayAdverts(); } // Refresh if viewing
    }

    async function handleAdminUploadAdvert(event) {
        event.preventDefault();
        if (!isAdminLoggedIn) { alert("Admin permission required."); return; }

        const title = document.getElementById('adminAdvertTitle').value.trim();
        const content = document.getElementById('adminAdvertContent').value.trim();
        const imageFile = document.getElementById('adminAdvertImage').files[0];
        const targetAudience = document.getElementById('adminAdvertAudience').value;
        adminAdvertMsgDiv.textContent = ''; adminAdvertMsgDiv.className = 'success-message'; // Reset

        if (!title || !content || !targetAudience) {
            adminAdvertMsgDiv.textContent = 'Title, Content, and Target Audience are required.';
            adminAdvertMsgDiv.className = 'error-message'; return;
        }

        let imageDataUrl = null;
        if (imageFile) {
            try { imageDataUrl = await readFileAsDataURL(imageFile); }
            catch (error) {
                console.error("Error reading advert image:", error);
                adminAdvertMsgDiv.textContent = 'Error processing image file.';
                adminAdvertMsgDiv.className = 'error-message'; return;
            }
        }

        const adverts = getFromLocalStorage(WANO_ADVERTS_KEY);
        const newAdvert = {
            id: `advert_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
            uploaderId: 'admin', uploaderType: 'admin', uploaderName: 'Wano Admin',
            title, content, image: imageDataUrl,
            timestamp: new Date().toISOString(), targetAudience: targetAudience
        };

        adverts.push(newAdvert); saveToLocalStorage(WANO_ADVERTS_KEY, adverts);
        adminAdvertMsgDiv.textContent = 'Advert uploaded successfully!'; adminAdvertForm.reset();
        setTimeout(() => { adminAdvertMsgDiv.textContent = ''; }, 3000);
        if (currentScreen === 'adverts') { displayAdverts(); } // Refresh if viewing
    }

    function displayAdverts() {
        advertsListDiv.innerHTML = ''; // Clear previous
        advertsStatusDiv.textContent = 'Loading adverts...';

        const allAdverts = getFromLocalStorage(WANO_ADVERTS_KEY);
        let currentUserType = 'guest'; // Default if not logged in
        if (isAdminLoggedIn) { currentUserType = 'admin'; }
        else if (loggedInBusinessInfo) { currentUserType = 'owner'; }
        else if (loggedInCustomerInfo) { currentUserType = 'customer'; }
        else if (loggedInPoliceInfo) { currentUserType = 'police'; } // NEW

        // Filter based on target audience
        const relevantAdverts = allAdverts.filter(advert => {
            if (advert.targetAudience === 'all') return true;
            if (currentUserType === 'admin') return true; // Admin sees all
            if (advert.targetAudience === 'customers' && currentUserType === 'customer') return true;
            if (advert.targetAudience === 'owners' && currentUserType === 'owner') return true;
            if (advert.targetAudience === 'police' && currentUserType === 'police') return true; // NEW Police target
            // Allow specific types to also see 'all' ads (implicitly covered by first condition)
            return false;
        }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first

        if (relevantAdverts.length === 0) {
            advertsStatusDiv.textContent = 'No announcements or adverts available for you at the moment.';
            return;
        }

        advertsStatusDiv.textContent = ''; // Clear loading message
        relevantAdverts.forEach(advert => {
            const card = document.createElement('div');
            card.className = 'advert-card';
            const uploaderClass = `uploader-type-${advert.uploaderType}`; // e.g., uploader-type-admin
            card.innerHTML = `
                <h4>${escapeHtml(advert.title)}</h4>
                ${advert.image ? `<img src="${advert.image}" alt="${escapeHtml(advert.title)} Image" class="advert-image">` : ''}
                <p>${escapeHtml(advert.content)}</p>
                <div class="advert-meta">
                    Posted by: <span class="${uploaderClass}">${escapeHtml(advert.uploaderName || advert.uploaderType)}</span>
                    <span>${new Date(advert.timestamp).toLocaleString()}</span>
                </div>
            `;
            advertsListDiv.appendChild(card);
        });
    }

    // --- Alert System Functions (NEW - Includes Media Handling) ---

    function openAlertModal() {
        // Reset form state
        alertForm.reset();
        alertSendErrorDiv.textContent = '';
        alertMediaPreviewDiv.innerHTML = '';
        alertMediaDataInput.value = ''; // Clear any previous media data
        alertLocationCoordsInput.value = '';
        alertLocationDisplay.textContent = 'Fetching location...';

        alertModal.style.display = 'block';
        getDeviceLocation(); // Attempt to get location immediately
    }

    function closeAlertModal() {
        alertModal.style.display = 'none';
    }

    function getDeviceLocation() {
        alertLocationDisplay.textContent = 'Fetching location...';
        alertLocationCoordsInput.value = ''; // Clear previous
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const coords = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    alertLocationDisplay.textContent = `Location captured: ${coords}`;
                    alertLocationCoordsInput.value = coords; // Store for sending
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let errorMsg = 'Could not get location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errorMsg += "Permission denied."; break;
                        case error.POSITION_UNAVAILABLE: errorMsg += "Location unavailable."; break;
                        case error.TIMEOUT: errorMsg += "Request timed out."; break;
                        default: errorMsg += "Unknown error."; break;
                    }
                    alertLocationDisplay.textContent = errorMsg + ' Please describe location in the reason.';
                    alertLocationCoordsInput.value = ''; // Ensure it's empty on error
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Options
            );
        } else {
            alertLocationDisplay.textContent = 'Geolocation is not supported by your browser.';
            alertLocationCoordsInput.value = '';
        }
    }

    // --- Media Capture Placeholders & Implementation ---

    function recordVideo() {
        alert("Video recording feature not implemented in this demo.\n\n(Requires MediaRecorder API)");
        // In a real app, you would use navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        // and the MediaRecorder API to capture and save video.
        alertMediaPreviewDiv.innerHTML = '<p><i>Video capture placeholder.</i></p>';
        alertMediaDataInput.value = 'video_placeholder'; // Indicate type for potential backend
    }

    function recordAudio() {
        alert("Audio recording feature not implemented in this demo.\n\n(Requires MediaRecorder API)");
        // Similar to video, use getUserMedia({ audio: true }) and MediaRecorder.
        alertMediaPreviewDiv.innerHTML = '<p><i>Audio capture placeholder.</i></p>';
        alertMediaDataInput.value = 'audio_placeholder'; // Indicate type
    }

    function captureImage() {
        alert("Direct image capture feature not implemented in this demo. Please use 'Upload Image'.\n\n(Could use getUserMedia + Canvas or input capture attribute)");
        // Option 1: Trigger a hidden file input with capture attribute
        // Option 2: Use getUserMedia({ video: true }) -> draw frame to canvas -> get Data URL
        alertMediaPreviewDiv.innerHTML = '<p><i>Direct photo capture placeholder.</i></p>';
        alertMediaDataInput.value = 'capture_placeholder'; // Indicate type
    }

    // Handle image upload from file input
    async function handleAlertImageUpload(event) {
        const file = event.target.files[0];
        alertMediaPreviewDiv.innerHTML = ''; // Clear previous preview/message
        alertMediaDataInput.value = ''; // Clear previous data

        if (file && file.type.startsWith('image/')) {
            alertMediaPreviewDiv.innerHTML = '<p><i>Processing image...</i></p>';
            try {
                const imageDataUrl = await readFileAsDataURL(file); // Use existing utility function
                alertMediaDataInput.value = imageDataUrl; // Store the Data URL
                alertMediaPreviewDiv.innerHTML = `<img src="${imageDataUrl}" alt="Uploaded Preview">`;
                console.log("Image loaded successfully as Data URL.");
            } catch (error) {
                console.error("Error reading uploaded image:", error);
                alertMediaPreviewDiv.innerHTML = '<p style="color:red;">Error reading image file.</p>';
                alertMediaDataInput.value = ''; // Clear on error
            }
        } else if (file) {
            // If a file was selected but it's not an image
            alertMediaPreviewDiv.innerHTML = '<p style="color:red;">Please select a valid image file (e.g., JPG, PNG, GIF).</p>';
            alertMediaDataInput.value = ''; // Clear if not image
            event.target.value = null; // Reset file input so user can select again
        }
        // If no file selected (e.g., user cancels), do nothing, keep preview empty.
    }

    // Modified handleSendAlert to include the media data
    function handleSendAlert(event) {
        event.preventDefault();
        alertSendErrorDiv.textContent = '';

        const reason = alertReasonTextarea.value.trim();
        const locationCoords = alertLocationCoordsInput.value; // String "lat, lon" or empty
        const mediaData = alertMediaDataInput.value; // Data URL for image, or placeholder string

        if (!reason) {
            alertSendErrorDiv.textContent = 'Please provide a reason for the alert.';
            return;
        }

        // Identify the sender
        let senderId = 'guest';
        let senderType = 'guest';
        let senderName = 'Guest User';
        if (loggedInPoliceInfo) { senderId = loggedInPoliceInfo.policeId; senderType = 'police'; senderName = loggedInPoliceInfo.name; }
        else if (isAdminLoggedIn) { senderId = 'admin'; senderType = 'admin'; senderName = 'Admin'; }
        else if (loggedInBusinessInfo) { senderId = loggedInBusinessInfo.id; senderType = 'owner'; senderName = loggedInBusinessInfo.businessName; }
        else if (loggedInCustomerInfo) { senderId = loggedInCustomerInfo.id; senderType = 'customer'; senderName = loggedInCustomerInfo.name; }

        let locationObj = null;
        if (locationCoords) {
            const [lat, lon] = locationCoords.split(',').map(s => s.trim());
            if (lat && lon) { locationObj = { lat: parseFloat(lat), lon: parseFloat(lon) }; }
        }

        // --- Prepare media object ---
        let mediaForStorage = [];
        if (mediaData) {
            let mediaType = 'unknown';
            if (mediaData.startsWith('data:image')) {
                mediaType = 'image_data_url';
            } else if (mediaData === 'video_placeholder') {
                 mediaType = 'video_placeholder'; // Or just 'video' if backend handles it
            } else if (mediaData === 'audio_placeholder') {
                 mediaType = 'audio_placeholder'; // Or just 'audio'
            } else if (mediaData === 'capture_placeholder') {
                mediaType = 'image_placeholder'; // Or just 'image'
            }
            // In a real app, you'd likely upload the file/blob and store a URL or ID.
            // For this demo, we store the Data URL directly for images.
            mediaForStorage.push({ type: mediaType, data: mediaData });
        }
        // --- End Prepare media object ---

        const newAlert = {
            id: `alert_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
            senderId: senderId,
            senderType: senderType,
            senderName: senderName,
            reason: reason,
            location: locationObj,
            media: mediaForStorage, // Use the prepared media array
            timestamp: new Date().toISOString(),
            status: 'New'
        };

        console.log("Sending Alert:", newAlert); // Log for debugging

        const alerts = getFromLocalStorage(ALERTS_KEY);
        alerts.push(newAlert);
        saveToLocalStorage(ALERTS_KEY, alerts);

        alert('Alert sent successfully!');
        closeAlertModal();

        // Refresh alert views if admin/police are logged in and viewing
        if (isAdminLoggedIn && currentScreen === 'admin') { displayAdminAlerts(); }
        if (loggedInPoliceInfo && currentScreen === 'police-alerts') { displayPoliceAlerts(loggedInPoliceInfo.policeId); }
    }

    // Modified displayAdminAlerts to show image previews
    function displayAdminAlerts() {
        if (!isAdminLoggedIn) return;
        const alerts = getFromLocalStorage(ALERTS_KEY);
        adminAlertsTableBody.innerHTML = '';
        adminAlertsStatusDiv.textContent = '';

        if (alerts.length === 0) {
            adminAlertsStatusDiv.textContent = 'No alerts received yet.';
            adminAlertsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No alerts have been sent.</td></tr>';
            return;
        }

        alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        alerts.forEach(alert => {
            const row = adminAlertsTableBody.insertRow();
            const senderInfo = `${escapeHtml(alert.senderName)} (${escapeHtml(alert.senderType)})`;
            const locationText = alert.location ? `${alert.location.lat}, ${alert.location.lon}` : 'N/A';
            const time = new Date(alert.timestamp);
            const formattedTime = `${time.toLocaleDateString()} ${time.toLocaleTimeString()}`;

            // Media display logic
            let mediaInfo = 'None';
            let mediaPreviewHtml = ''; // Changed to Html
            if (alert.media && alert.media.length > 0) {
                 const firstMedia = alert.media[0];
                 if (firstMedia.type === 'image_data_url' && firstMedia.data.startsWith('data:image')) {
                     mediaInfo = 'Image Attached';
                     // Added style for thumbnail size
                     mediaPreviewHtml = `<img src="${firstMedia.data}" alt="Alert Media" title="Attached Image" style="max-width: 80px; max-height: 60px; display: block; margin-top: 5px; cursor: pointer;">`;
                 } else if (firstMedia.type === 'video_placeholder' || firstMedia.type === 'audio_placeholder' || firstMedia.type === 'image_placeholder') {
                     mediaInfo = `${firstMedia.type.split('_')[0].charAt(0).toUpperCase() + firstMedia.type.split('_')[0].slice(1)} (Placeholder)`;
                 } else {
                     mediaInfo = 'Media Attached (Unknown)';
                 }
            }

            let statusClass = '';
            switch (alert.status?.toLowerCase()) {
                case 'viewed': statusClass = 'alert-status-viewed'; break;
                case 'actioned': statusClass = 'alert-status-actioned'; break;
                default: statusClass = 'alert-status-new'; break;
            }

            row.innerHTML = `
                <td>${escapeHtml(formattedTime)}</td>
                <td>${senderInfo}</td>
                <td class="alert-reason">${escapeHtml(alert.reason)}</td>
                <td class="alert-location">${escapeHtml(locationText)}</td>
                <td class="alert-media">${mediaInfo}${mediaPreviewHtml}</td>
                <td class="${statusClass}">${escapeHtml(alert.status || 'New')}</td>
                <!-- Add Action buttons here if needed: View, Action, Delete -->
            `;
        });
    }

    // Modified displayPoliceAlerts to show image previews
    function displayPoliceAlerts(policeUserId) {
        if (!loggedInPoliceInfo || loggedInPoliceInfo.policeId !== policeUserId) return;
        const alerts = getFromLocalStorage(ALERTS_KEY);
        policeAlertsTableBody.innerHTML = '';
        policeAlertsStatusDiv.textContent = '';

        if (alerts.length === 0) {
            policeAlertsStatusDiv.textContent = 'No alerts received.';
            policeAlertsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No alerts have been sent.</td></tr>';
            return;
        }

        alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        alerts.forEach(alert => {
             const row = policeAlertsTableBody.insertRow();
             const senderInfo = `${escapeHtml(alert.senderName)} (${escapeHtml(alert.senderType)})`;
             const locationText = alert.location ? `${alert.location.lat}, ${alert.location.lon}` : 'N/A';
             const time = new Date(alert.timestamp);
             const formattedTime = `${time.toLocaleDateString()} ${time.toLocaleTimeString()}`;

             // Media display logic
             let mediaInfo = 'None';
             let mediaPreviewHtml = ''; // Changed to Html
             if (alert.media && alert.media.length > 0) {
                  const firstMedia = alert.media[0];
                  if (firstMedia.type === 'image_data_url' && firstMedia.data.startsWith('data:image')) {
                      mediaInfo = 'Image Attached';
                       // Added style for thumbnail size
                      mediaPreviewHtml = `<img src="${firstMedia.data}" alt="Alert Media" title="Attached Image" style="max-width: 80px; max-height: 60px; display: block; margin-top: 5px; cursor: pointer;">`;
                  } else if (firstMedia.type === 'video_placeholder' || firstMedia.type === 'audio_placeholder' || firstMedia.type === 'image_placeholder') {
                      mediaInfo = `${firstMedia.type.split('_')[0].charAt(0).toUpperCase() + firstMedia.type.split('_')[0].slice(1)} (Placeholder)`;
                  } else {
                      mediaInfo = 'Media Attached (Unknown)';
                  }
             }

             let statusClass = '';
             switch (alert.status?.toLowerCase()) {
                 case 'viewed': statusClass = 'alert-status-viewed'; break;
                 case 'actioned': statusClass = 'alert-status-actioned'; break;
                 default: statusClass = 'alert-status-new'; break;
             }

             row.innerHTML = `
                 <td>${escapeHtml(formattedTime)}</td>
                 <td>${senderInfo}</td>
                 <td class="alert-reason">${escapeHtml(alert.reason)}</td>
                 <td class="alert-location">${escapeHtml(locationText)}</td>
                 <td class="alert-media">${mediaInfo}${mediaPreviewHtml}</td>
                 <td class="${statusClass}">${escapeHtml(alert.status || 'New')}</td>
                 <!-- Add Police Action buttons: Mark Viewed, Mark Actioned -->
             `;
        });
    }


/* --- SECURITY WARNING --- */
/* ==========================================================================
 *   !!! SECURITY WARNING !!!
 * ==========================================================================
 * This application uses localStorage for data storage and performs
 * authentication (including admin/police checks), password changes/resets, and
 * sensitive actions (like alerts with media) entirely on the client-side.
 * THIS IS EXTREMELY INSECURE AND UNSUITABLE FOR PRODUCTION ENVIRONMENTS.
 * - Data in localStorage is easily accessible and modifiable by the user.
 * - Passwords stored in plain text are a major security risk.
 * - Admin/Police credentials/checks hardcoded or managed client-side are trivial to bypass.
 * - Alert data (including location, reasons, media Data URLs) is not protected.
 * This implementation is for DEMONSTRATION PURPOSES ONLY. A real-world
 * application requires a secure backend server, database, proper session
 * management, server-side validation, secure media storage, encryption, and access controls.
 * ========================================================================== */
</script>

<!-- Basic PWA Manifest File (save as manifest.json) -->
<!-- Contents should be same as provided previously -->

<!-- Basic Service Worker File (save as sw.js) -->
<!-- Contents should be same as provided previously -->

</body>
</html>
